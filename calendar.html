<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WOLF CALENDAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    
    <meta name="theme-color" content="#1c1917">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wolf: {
                            bg: '#0c0a09', surface: '#1c1917', border: '#44403c',  
                            text: '#e7e5e4', accent: '#b45309', accentHover: '#92400e',
                            muted: '#78716c', pos: '#15803d'
                        }
                    },
                    fontFamily: { heading: ['Oswald', 'sans-serif'], body: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        /* Fix for mobile height issues */
        body { 
            background-color: #0c0a09; 
            color: #e7e5e4; 
            font-family: 'Inter', sans-serif; 
            overscroll-behavior: none;
            height: 100dvh; /* Dynamic Viewport Height for mobile browsers */
        }
        h1, h2, h3, .font-heading { font-family: 'Oswald', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0c0a09; }
        ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 3px; }

        /* Timeline Grid */
        .time-slot { height: 90px; border-bottom: 1px solid #292524; position: relative; } 
        .time-label { position: absolute; top: -10px; left: 2px; font-size: 10px; color: #78716c; background: #0c0a09; padding-right: 4px; }
        
        .event-card {
            position: absolute; left: 50px; right: 10px;
            background: #292524; border-left: 4px solid #b45309;
            padding: 4px 8px; font-size: 12px; overflow: hidden;
            border-radius: 4px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: transform 0.1s;
            z-index: 10;
        }
        .event-card:active { transform: scale(0.98); }
        .event-card.completed { opacity: 0.5; border-left-color: #15803d; text-decoration: line-through; }
        .event-card.recurring { border-right: 2px solid #b45309; }
        
        .tab-btn.active { border-bottom: 2px solid #b45309; color: white; }
        .tab-btn { color: #78716c; }
    </style>
</head>
<body class="flex flex-col overflow-hidden">

    <div class="flex flex-col md:flex-row md:justify-between md:items-center p-4 border-b border-wolf-border bg-wolf-bg z-20 gap-4 md:gap-0 shrink-0">
        <div class="flex items-center gap-4 justify-between md:justify-start">
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-wolf-muted hover:text-white text-xs font-bold uppercase tracking-widest no-underline">&larr; Home</a>
                <h1 class="font-heading text-2xl text-wolf-accent tracking-wide">PLANNER</h1>
            </div>
            <div class="flex items-center gap-2 md:hidden">
                <button onclick="changeDate(-1)" class="text-wolf-muted hover:text-white p-1">&larr;</button>
                <div id="current-date-mobile" class="text-wolf-text text-xs font-bold uppercase tracking-widest text-center min-w-[100px]"></div>
                <button onclick="changeDate(1)" class="text-wolf-muted hover:text-white p-1">&rarr;</button>
            </div>
        </div>

        <div class="hidden md:flex items-center gap-4 bg-wolf-surface/50 px-4 py-2 rounded-lg border border-wolf-border">
            <button onclick="changeDate(-1)" class="text-wolf-muted hover:text-white font-heading text-lg">&larr;</button>
            <button onclick="setDateToToday()" class="text-xs uppercase font-bold text-wolf-accent tracking-widest hover:text-white">Today</button>
            <div id="current-date-desktop" class="text-wolf-text text-sm font-bold uppercase tracking-widest text-center min-w-[150px]"></div>
            <button onclick="changeDate(1)" class="text-wolf-muted hover:text-white font-heading text-lg">&rarr;</button>
        </div>
    </div>

    <div class="flex md:hidden border-b border-wolf-border bg-wolf-surface shrink-0">
        <button onclick="switchTab('todo')" id="tab-todo" class="tab-btn flex-1 py-3 text-sm font-bold uppercase tracking-widest">Tasks</button>
        <button onclick="switchTab('calendar')" id="tab-calendar" class="tab-btn active flex-1 py-3 text-sm font-bold uppercase tracking-widest">Timeline</button>
    </div>

    <div class="flex-grow flex overflow-hidden relative">
        
        <div id="panel-todo" class="hidden md:flex flex-col w-full md:w-80 border-r border-wolf-border bg-wolf-surface/50 h-full absolute md:relative z-10 md:z-auto">
            <div class="p-4 border-b border-wolf-border">
                <h2 class="font-heading text-xl text-wolf-muted mb-3">TO-DO LIST</h2>
                <div class="flex gap-2">
                    <input type="text" id="new-todo-input" placeholder="Add task..." class="flex-1 bg-wolf-bg border border-wolf-border text-white px-3 py-2 rounded text-sm focus:border-wolf-accent outline-none">
                    <button onclick="addTodo()" class="bg-wolf-accent text-white px-3 py-2 rounded font-heading font-bold">+</button>
                </div>
            </div>
            <div id="todo-list" class="flex-grow overflow-y-auto p-4 space-y-2 pb-20"></div>
        </div>

        <div id="panel-calendar" class="flex-grow flex flex-col h-full w-full bg-wolf-bg relative">
            <div id="time-marker" class="absolute left-0 w-full border-t border-red-500 z-10 pointer-events-none" style="top: 0px; display: none;">
                <span class="absolute right-0 -top-2.5 bg-red-500 text-white text-[9px] px-1 rounded">NOW</span>
            </div>

            <div id="timeline-container" class="flex-grow overflow-y-auto relative pb-32 pt-2"></div>
            
            <button onclick="openEventModal()" class="absolute bottom-24 md:bottom-8 right-6 bg-wolf-accent text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-3xl font-heading hover:bg-wolf-accentHover z-20 shadow-orange-900/40">
                +
            </button>
        </div>

    </div>

    <div id="event-modal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-wolf-surface border border-wolf-border p-6 w-full max-w-md rounded-xl shadow-2xl flex flex-col max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="font-heading text-2xl text-wolf-accent mb-6">PLAN EVENT</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Title</label>
                    <input type="text" id="event-title" placeholder="What are you doing?" class="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none">
                </div>

                <div>
                    <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Date</label>
                    <input type="date" id="event-date" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 rounded text-sm focus:border-wolf-accent outline-none">
                </div>

                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Start</label>
                        <input type="time" id="event-start" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 rounded text-sm focus:border-wolf-accent outline-none">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">End</label>
                        <input type="time" id="event-end" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 rounded text-sm focus:border-wolf-accent outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Repeat</label>
                    <select id="event-recurrence" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 rounded text-sm form-select focus:border-wolf-accent outline-none">
                        <option value="none">Don't Repeat</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Every 3 Months</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Link To-Do Item</label>
                    <select id="event-todo-link" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 rounded text-sm focus:border-wolf-accent outline-none">
                        <option value="">-- None --</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Notes</label>
                    <textarea id="event-note" rows="3" placeholder="Details..." class="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none"></textarea>
                </div>

                <div class="flex items-center gap-2 pt-2">
                    <input type="checkbox" id="event-completed" class="w-5 h-5 accent-wolf-accent cursor-pointer">
                    <label for="event-completed" class="text-sm text-white cursor-pointer select-none">Mark as Completed</label>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="saveEvent()" class="flex-1 bg-wolf-accent text-white py-3 rounded font-heading tracking-wider hover:bg-wolf-accentHover">SAVE</button>
                <button onclick="deleteEvent()" id="btn-delete" class="flex-1 bg-transparent border border-red-900 text-red-500 py-3 rounded font-heading tracking-wider hover:bg-red-900/20 hidden">DELETE</button>
            </div>
            <button onclick="closeModal()" class="mt-4 text-wolf-muted text-xs uppercase tracking-widest hover:text-white text-center">Cancel</button>
        </div>
    </div>

    <script>
        const STORAGE_TODOS = 'wolf_planner_todos';
        const STORAGE_EVENTS = 'wolf_planner_events';
        const PIXELS_PER_MIN = 1.5;

        // State
        let todos = JSON.parse(localStorage.getItem(STORAGE_TODOS)) || [];
        let events = JSON.parse(localStorage.getItem(STORAGE_EVENTS)) || [];
        
        // Migration: Ensure legacy events have a date (default to today if missing)
        const todayStr = new Date().toISOString().split('T')[0];
        events = events.map(e => {
            if(!e.date) e.date = todayStr;
            return e;
        });

        let viewDate = new Date(); // Current date being viewed
        let editingEventId = null;

        // DOM Elements
        const els = {
            todoList: document.getElementById('todo-list'),
            timeline: document.getElementById('timeline-container'),
            todoInput: document.getElementById('new-todo-input'),
            modal: document.getElementById('event-modal'),
            modalTitle: document.getElementById('modal-title'),
            inpTitle: document.getElementById('event-title'),
            inpDate: document.getElementById('event-date'),
            inpStart: document.getElementById('event-start'),
            inpEnd: document.getElementById('event-end'),
            inpRecur: document.getElementById('event-recurrence'),
            inpNote: document.getElementById('event-note'),
            inpTodo: document.getElementById('event-todo-link'),
            inpComp: document.getElementById('event-completed'),
            btnDelete: document.getElementById('btn-delete'),
            dateDesktop: document.getElementById('current-date-desktop'),
            dateMobile: document.getElementById('current-date-mobile'),
            timeMarker: document.getElementById('time-marker')
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            renderHeaderDate();
            renderTimelineBackground();
            renderTodos();
            renderEvents();
            
            setInterval(() => {
                if(isToday(viewDate)) updateTimeMarker();
                else els.timeMarker.style.display = 'none';
            }, 60000);
            
            if(window.innerWidth < 768) switchTab('calendar');
        });

        // --- DATE LOGIC ---
        window.changeDate = (delta) => {
            viewDate.setDate(viewDate.getDate() + delta);
            renderHeaderDate();
            renderEvents();
            if(isToday(viewDate)) updateTimeMarker();
            else els.timeMarker.style.display = 'none';
        };

        window.setDateToToday = () => {
            viewDate = new Date();
            renderHeaderDate();
            renderEvents();
            updateTimeMarker();
        };

        function renderHeaderDate() {
            const str = viewDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            els.dateDesktop.textContent = str;
            els.dateMobile.textContent = str;
        }

        function isToday(d) {
            const now = new Date();
            return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        }

        function toISODate(d) {
            // Local date ISO string hack to prevent TZ shift
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        }

        // --- TABS (Mobile) ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            if (tab === 'todo') {
                document.getElementById('panel-todo').classList.remove('hidden');
                document.getElementById('panel-calendar').classList.add('hidden');
            } else {
                document.getElementById('panel-todo').classList.add('hidden');
                document.getElementById('panel-calendar').classList.remove('hidden');
            }
        };

        // --- TIMELINE RENDERER ---
        function renderTimelineBackground() {
            els.timeline.innerHTML = '';
            for(let i=0; i<24; i++) {
                const slot = document.createElement('div');
                slot.className = 'time-slot w-full';
                const label = document.createElement('div');
                label.className = 'time-label font-heading';
                label.textContent = `${i.toString().padStart(2,'0')}:00`;
                slot.appendChild(label);
                
                slot.addEventListener('click', (e) => {
                    if(e.target === slot) openEventModal(null, i);
                });
                
                els.timeline.appendChild(slot);
            }
            if(isToday(viewDate)) updateTimeMarker();
        }

        function updateTimeMarker() {
            const now = new Date();
            const mins = (now.getHours() * 60) + now.getMinutes();
            const top = mins * PIXELS_PER_MIN;
            els.timeMarker.style.display = 'block';
            els.timeMarker.style.top = `${top}px`;
        }

        function renderEvents() {
            document.querySelectorAll('.event-card').forEach(e => e.remove());
            
            const viewDateStr = toISODate(viewDate);

            events.forEach(evt => {
                let shouldRender = false;

                // 1. Check Exact Date
                if (evt.date === viewDateStr) {
                    shouldRender = true;
                }
                // 2. Check Recurrence
                else if (evt.recurrence && evt.recurrence !== 'none') {
                    shouldRender = checkRecurrence(evt, viewDate);
                }

                if (shouldRender) {
                    const startMins = getMinutesFromTime(evt.start);
                    const endMins = getMinutesFromTime(evt.end);
                    const duration = endMins - startMins;
                    const top = startMins * PIXELS_PER_MIN;
                    const height = Math.max(duration * PIXELS_PER_MIN, 20);

                    const card = document.createElement('div');
                    card.className = `event-card ${evt.completed ? 'completed' : ''} ${evt.recurrence !== 'none' ? 'recurring' : ''}`;
                    card.style.top = `${top}px`;
                    card.style.height = `${height}px`;

                    let noteIcon = evt.note ? '<span class="text-[10px] opacity-70">üìù </span>' : '';
                    let recurIcon = evt.recurrence !== 'none' ? '<span class="text-[10px] opacity-70">‚Üª </span>' : '';
                    
                    card.innerHTML = `
                        <div class="font-bold truncate leading-tight">${recurIcon}${evt.title}</div>
                        <div class="text-[10px] opacity-80 truncate">${evt.start} - ${evt.end} ${noteIcon}</div>
                        ${evt.note ? `<div class="text-[9px] text-wolf-muted truncate mt-1 italic">"${evt.note}"</div>` : ''}
                    `;
                    
                    card.onclick = (e) => {
                        e.stopPropagation();
                        openEventModal(evt);
                    };
                    els.timeline.appendChild(card);
                }
            });
        }

        function checkRecurrence(evt, currentViewDate) {
            const evtDate = new Date(evt.date + 'T00:00:00');
            const view = new Date(toISODate(currentViewDate) + 'T00:00:00');
            
            // If view is before start date, don't show
            if (view < evtDate) return false;

            const diffTime = Math.abs(view - evtDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            if (evt.recurrence === 'daily') return true;
            if (evt.recurrence === 'weekly') return diffDays % 7 === 0;
            if (evt.recurrence === 'monthly') return view.getDate() === evtDate.getDate();
            if (evt.recurrence === 'quarterly') {
                // Same day of month AND month difference is multiple of 3
                let months = (view.getFullYear() - evtDate.getFullYear()) * 12 + (view.getMonth() - evtDate.getMonth());
                return view.getDate() === evtDate.getDate() && months % 3 === 0;
            }
            if (evt.recurrence === 'yearly') {
                return view.getMonth() === evtDate.getMonth() && view.getDate() === evtDate.getDate();
            }
            return false;
        }

        // --- TODO LOGIC ---
        function renderTodos() {
            els.todoList.innerHTML = '';
            todos.forEach(todo => {
                const div = document.createElement('div');
                div.className = "bg-wolf-bg border border-wolf-border p-3 rounded flex items-center justify-between group";
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div onclick="toggleTodo('${todo.id}')" class="w-5 h-5 rounded border ${todo.completed ? 'bg-wolf-pos border-wolf-pos' : 'border-wolf-muted'} flex items-center justify-center cursor-pointer shrink-0">
                            ${todo.completed ? '<span class="text-white text-xs">‚úì</span>' : ''}
                        </div>
                        <span class="${todo.completed ? 'text-wolf-muted line-through' : 'text-white'} truncate text-sm">${todo.title}</span>
                    </div>
                    <button onclick="deleteTodo('${todo.id}')" class="text-wolf-muted hover:text-red-500 text-xs px-2 opacity-0 group-hover:opacity-100 transition">‚úï</button>
                `;
                els.todoList.appendChild(div);
            });
            localStorage.setItem(STORAGE_TODOS, JSON.stringify(todos));
        }

        window.addTodo = () => {
            const val = els.todoInput.value.trim();
            if(!val) return;
            todos.push({ id: Date.now().toString(), title: val, completed: false });
            els.todoInput.value = '';
            renderTodos();
            updateModalDropdown();
        };

        window.toggleTodo = (id) => {
            const t = todos.find(x => x.id === id);
            if(t) {
                t.completed = !t.completed;
                renderTodos();
                // Link Check: Sync with Event if connected
                const linkedEvent = events.find(e => e.todoId === id);
                if(linkedEvent) {
                    linkedEvent.completed = t.completed;
                    saveEvents();
                    renderEvents();
                }
            }
        };

        window.deleteTodo = (id) => {
            if(!confirm("Delete task?")) return;
            todos = todos.filter(t => t.id !== id);
            renderTodos();
        };

        // --- EVENT LOGIC ---
        window.openEventModal = (evt = null, hour = null) => {
            updateModalDropdown();
            els.modal.classList.remove('hidden');
            
            if(evt) {
                editingEventId = evt.id;
                els.modalTitle.textContent = "EDIT EVENT";
                els.inpTitle.value = evt.title;
                els.inpDate.value = evt.date;
                els.inpStart.value = evt.start;
                els.inpEnd.value = evt.end;
                els.inpRecur.value = evt.recurrence || 'none';
                els.inpNote.value = evt.note || '';
                els.inpTodo.value = evt.todoId || '';
                els.inpComp.checked = evt.completed;
                els.btnDelete.classList.remove('hidden');
            } else {
                editingEventId = null;
                els.modalTitle.textContent = "PLAN EVENT";
                els.inpTitle.value = '';
                els.inpDate.value = toISODate(viewDate); // Default to current view
                els.inpRecur.value = 'none';
                els.inpNote.value = '';
                els.inpTodo.value = '';
                els.inpComp.checked = false;
                els.btnDelete.classList.add('hidden');
                
                const hStr = (hour !== null ? hour : new Date().getHours()).toString().padStart(2,'0');
                els.inpStart.value = `${hStr}:00`;
                els.inpEnd.value = `${hStr}:30`;
            }
        };

        window.closeModal = () => els.modal.classList.add('hidden');

        function updateModalDropdown() {
            els.inpTodo.innerHTML = '<option value="">-- None --</option>';
            todos.filter(t => !t.completed).forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.title;
                els.inpTodo.appendChild(opt);
            });
        }

        window.saveEvent = () => {
            const title = els.inpTitle.value.trim();
            const date = els.inpDate.value;
            const start = els.inpStart.value;
            const end = els.inpEnd.value;
            const recurrence = els.inpRecur.value;
            const note = els.inpNote.value;
            const todoId = els.inpTodo.value;
            const completed = els.inpComp.checked;

            if(!title || !start || !end || !date) return alert("Please fill title, date, and times");

            if(editingEventId) {
                const idx = events.findIndex(e => e.id === editingEventId);
                if(idx > -1) {
                    events[idx] = { ...events[idx], title, date, start, end, recurrence, note, todoId, completed };
                }
            } else {
                events.push({
                    id: Date.now().toString(),
                    title, date, start, end, recurrence, note, todoId, completed
                });
            }

            // Sync Todo Completion
            if(completed && todoId) {
                const t = todos.find(x => x.id === todoId);
                if(t && !t.completed) {
                    t.completed = true;
                    renderTodos();
                }
            }

            saveEvents();
            renderEvents();
            closeModal();
        };

        window.deleteEvent = () => {
            if(!confirm("Remove from calendar?")) return;
            events = events.filter(e => e.id !== editingEventId);
            saveEvents();
            renderEvents();
            closeModal();
        };

        function saveEvents() {
            localStorage.setItem(STORAGE_EVENTS, JSON.stringify(events));
        }

        function getMinutesFromTime(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }
    </script>
</body>
</html>
