<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOLF AI COACH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    
    <meta name="theme-color" content="#1c1917">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/292524/d6d3d1?text=W" sizes="180x180">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wolf: {
                            bg: '#0c0a09', surface: '#1c1917', border: '#44403c',  
                            text: '#e7e5e4', accent: '#b45309', accentHover: '#92400e',
                            muted: '#78716c', pos: '#15803d', neg: '#991b1b',
                        }
                    },
                    fontFamily: { heading: ['Oswald', 'sans-serif'], body: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0c0a09; color: #e7e5e4; font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        h1, h2, h3, .font-heading { font-family: 'Oswald', sans-serif; }
        .screen { display: none; }
        .active { display: flex; }
        .btn-primary { background-color: #b45309; color: white; font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.1em; border-radius: 0.5rem; transition: all 0.2s; }
        .btn-primary:active { transform: translateY(1px); }
        .btn-secondary { background-color: #292524; border: 1px solid #44403c; color: #d6d3d1; font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.1em; border-radius: 0.5rem; transition: all 0.2s; }
        .btn-secondary:active { transform: translateY(1px); }
        .form-select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0c0a09; }
        ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 3px; }
    </style>
</head>
<body class="h-screen overflow-hidden selection:bg-wolf-accent selection:text-white">

    <div id="ai-coach-modal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-wolf-surface border border-wolf-border p-6 w-full max-w-md rounded-xl shadow-2xl flex flex-col">
            <h2 class="font-heading text-3xl text-wolf-accent mb-1 text-center">AI COMMAND</h2>
            <p class="text-wolf-muted text-xs text-center mb-6 uppercase tracking-widest">Generate Mission</p>

            <div class="space-y-4 mb-6">
                <div id="api-key-container" class="hidden">
                    <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Gemini API Key</label>
                    <input type="password" id="ai-api-key" placeholder="Paste Key Here" class="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none text-sm">
                    <p class="text-[9px] text-wolf-muted mt-1">Key is stored locally on your device.</p>
                </div>
                <div id="api-key-status" class="hidden text-center mb-2">
                    <p class="text-xs text-wolf-pos font-bold uppercase tracking-widest">System Online</p>
                    <button onclick="resetAPI()" class="text-[10px] text-wolf-muted underline mt-1 hover:text-white">Change API Key</button>
                </div>

                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Time (Mins)</label>
                        <select id="ai-time" class="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded text-sm form-select focus:border-wolf-accent outline-none">
                            <option value="15">15 Minutes</option>
                            <option value="20">20 Minutes</option>
                            <option value="30" selected>30 Minutes</option>
                            <option value="45">45 Minutes</option>
                            <option value="60">60 Minutes</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Energy</label>
                        <select id="ai-energy" class="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded text-sm form-select focus:border-wolf-accent outline-none">
                            <option value="High" selected>High (Full Send)</option>
                            <option value="Medium">Medium (Steady)</option>
                            <option value="Low">Low (Recovery)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Location / Kit</label>
                    <select id="ai-location" class="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded text-sm form-select focus:border-wolf-accent outline-none">
                        <option value="Garage" selected>Garage (Full Gym + Run)</option>
                        <option value="Room">Room (Light KB, Abmat, Medball)</option>
                    </select>
                </div>
            </div>

            <button onclick="generateWorkout()" id="generate-btn" class="w-full btn-primary py-4 text-xl shadow-lg shadow-orange-900/20 relative overflow-hidden">
                <span id="gen-text">GENERATE</span>
                <span id="gen-loader" class="hidden absolute inset-0 flex items-center justify-center bg-wolf-accent">
                    <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </span>
            </button>
            <button onclick="goToMenu()" class="mt-4 text-wolf-muted text-xs uppercase tracking-widest hover:text-white text-center">Use Saved Protocols Instead</button>
        </div>
    </div>

    <div id="preview-screen" class="screen min-h-screen w-full flex-col p-6 bg-wolf-bg">
        <div class="max-w-2xl mx-auto w-full flex flex-col h-full">
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-wolf-border">
                <h2 class="font-heading text-3xl text-wolf-text">MISSION BRIEF</h2>
                <button onclick="openAICoach()" class="text-wolf-muted hover:text-white text-xs uppercase font-bold tracking-widest">Abort</button>
            </div>
            
            <div id="preview-list" class="flex-grow overflow-y-auto space-y-3 pb-8 pr-1"></div>

            <div class="pt-4 mt-2 border-t border-wolf-border">
                <button onclick="acceptMission()" class="w-full btn-primary py-4 text-xl shadow-lg shadow-orange-900/20">START MISSION</button>
            </div>
        </div>
    </div>

    <div id="menu-screen" class="screen active h-full w-full flex-col items-center justify-center p-6 relative">
        <a href="index.html" class="absolute top-6 left-6 text-wolf-muted hover:text-white transition text-xs font-bold uppercase tracking-widest no-underline">&larr; Home</a>
        <div class="z-10 text-center w-full max-w-sm flex flex-col items-center">
            <h1 class="font-heading text-6xl text-wolf-text tracking-tight mb-2">AI<span class="text-wolf-accent">COACH</span></h1>
            <p class="text-wolf-muted text-sm uppercase tracking-[0.3em] mb-12">Ready to Deploy</p>
            <div class="w-full space-y-3">
                 <button onclick="openAICoach()" class="w-full btn-primary py-4 text-xl shadow-lg shadow-orange-900/20">NEW MISSION</button>
                 <button onclick="resetAPI()" class="btn-secondary w-full py-3 text-xs tracking-widest text-wolf-muted uppercase font-bold">Reset API Key</button>
            </div>
        </div>
    </div>

    <div id="quote-screen" class="screen min-h-screen w-full flex-col items-center justify-center p-8 text-center bg-wolf-bg">
        <div class="z-10 max-w-2xl">
            <div class="w-16 h-1 bg-wolf-accent mx-auto mb-8 rounded-full"></div>
            <blockquote id="quote-text" class="font-heading text-3xl md:text-5xl text-wolf-text leading-tight opacity-90"></blockquote>
            <cite id="quote-author" class="block text-wolf-muted font-bold text-sm mt-6 uppercase tracking-widest"></cite>
        </div>
        <button id="start-btn" class="z-10 mt-16 btn-primary py-4 px-12 text-2xl shadow-xl shadow-orange-900/10">BEGIN</button>
    </div>

    <div id="workout-screen" class="screen h-full w-full flex-col relative bg-wolf-bg">
        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-20">
            <div><span class="text-wolf-muted text-[10px] uppercase tracking-widest block">Elapsed</span><span id="total-time-display" class="font-heading text-2xl text-wolf-text">--:--</span></div>
            <button onclick="goToMenu()" class="text-wolf-muted hover:text-white text-xs font-bold uppercase tracking-widest px-3 py-1 border border-transparent hover:border-wolf-muted rounded transition">Exit</button>
        </div>
        <div class="flex-grow flex flex-col items-center justify-center p-4 z-10 w-full max-w-4xl mx-auto mt-10">
            <div class="w-full bg-wolf-surface h-1.5 mb-12 rounded-full overflow-hidden"><div id="progress-bar" class="bg-wolf-accent h-full transition-all duration-300 rounded-full" style="width: 0%"></div></div>
            <p id="status-text" class="font-heading text-3xl text-wolf-accent uppercase tracking-widest mb-2 animate-pulse">Prepare</p>
            <p id="current-exercise" class="text-4xl md:text-7xl font-bold text-white mb-8 text-center leading-none tracking-tight"></p>
            <p id="current-reps" class="hidden text-5xl font-heading text-wolf-accent mb-4">x 0</p>
            
            <div id="timed-content" class="w-full text-center">
                <div id="timer-display" class="font-heading text-[8rem] md:text-[14rem] text-wolf-text leading-none select-none tabular-nums">10</div>
                <div id="amrap-counter-container" class="hidden mt-6 flex flex-col items-center animate-in fade-in"><p class="text-wolf-muted uppercase text-xs tracking-widest mb-2">Round Tracker</p><div class="flex items-center gap-6"><div id="amrap-rounds" class="font-heading text-6xl text-white">0</div><button onclick="incrementRound()" class="btn-secondary px-6 py-4 text-xl font-bold border-wolf-accent text-wolf-accent hover:bg-wolf-accent hover:text-white">+ ROUND</button></div></div>
            </div>

            <button id="manual-next-btn" class="hidden mt-8 btn-primary px-16 py-6 text-2xl mx-auto shadow-xl shadow-wolf-accent/20">NEXT &rarr;</button>

            <div id="rep-content" class="hidden w-full text-center max-w-xl">
                <div id="apex-exercise-list" class="text-left text-lg font-medium mb-10 space-y-3 bg-wolf-surface p-6 rounded-xl border border-wolf-border"></div>
            </div>
        </div>
        <div class="p-6 z-20 pb-10 text-center"><span class="text-wolf-muted text-[10px] uppercase tracking-widest block mb-1">Up Next</span><span id="next-exercise" class="text-wolf-text text-xl font-heading uppercase"></span></div>
    </div>

    <div id="completion-screen" class="screen min-h-screen w-full flex-col items-center justify-center p-6 text-center bg-wolf-bg">
        <h2 class="font-heading text-5xl md:text-8xl text-wolf-accent mb-2">COMPLETE</h2>
        <div class="bg-wolf-surface border border-wolf-border p-8 w-full max-w-sm mb-10 rounded-xl">
            <p class="text-wolf-muted text-[10px] uppercase tracking-widest mb-1">Total Time</p>
            <p id="final-time-display" class="text-6xl text-white font-heading my-2">--:--</p>
        </div>
        <button onclick="goToMenu()" class="btn-secondary w-full max-w-sm py-4 text-lg">EXIT</button>
    </div>

    <script>
        const STORAGE_KEY_ROUTINES = 'wolf_routines';
        const STORAGE_KEY_API = 'wolf_ai_key';
        
        const screens = { 
            menu: document.getElementById('menu-screen'), 
            preview: document.getElementById('preview-screen'), 
            quote: document.getElementById('quote-screen'), 
            workout: document.getElementById('workout-screen'), 
            completion: document.getElementById('completion-screen') 
        };
        
        const els = {
            timer: document.getElementById('timer-display'), currEx: document.getElementById('current-exercise'), nextEx: document.getElementById('next-exercise'), status: document.getElementById('status-text'),
            bar: document.getElementById('progress-bar'), timed: document.getElementById('timed-content'), rep: document.getElementById('rep-content'), manualBtn: document.getElementById('manual-next-btn'),
            apexList: document.getElementById('apex-exercise-list'), totalTime: document.getElementById('total-time-display'), finalTime: document.getElementById('final-time-display'),
            amrapContainer: document.getElementById('amrap-counter-container'), amrapRounds: document.getElementById('amrap-rounds'),
            previewList: document.getElementById('preview-list'), currReps: document.getElementById('current-reps')
        };
        
        let routines = JSON.parse(localStorage.getItem(STORAGE_KEY_ROUTINES)) || {};
        let activeRoutine = [];       // The raw, high-level routine (for Preview)
        let executionQueue = [];      // The flattened, unrolled routine (for Execution)
        let stepIndex = 0; let timerInt = null; let totalInt = null; let startTime = null; let audioCtx; let manualRoundCount = 0;

        window.addEventListener('DOMContentLoaded', () => {
            openAICoach(); 
            document.getElementById('start-btn').addEventListener('click', startWorkoutSession);
        });

        function openAICoach() {
            const storedKey = localStorage.getItem(STORAGE_KEY_API);
            const container = document.getElementById('api-key-container');
            const status = document.getElementById('api-key-status');
            
            if (!storedKey) {
                container.classList.remove('hidden');
                status.classList.add('hidden');
            } else {
                container.classList.add('hidden');
                status.classList.remove('hidden');
            }
            openModal('ai-coach-modal');
        }

        function resetAPI() { 
            localStorage.removeItem(STORAGE_KEY_API); 
            location.reload(); 
        }

        async function generateWorkout() {
            let apiKey = localStorage.getItem(STORAGE_KEY_API);
            const inputKey = document.getElementById('ai-api-key').value.trim();
            if (!apiKey) {
                if (!inputKey) return alert("Please enter a Gemini API Key.");
                apiKey = inputKey; localStorage.setItem(STORAGE_KEY_API, apiKey);
            }

            const btn = document.getElementById('generate-btn'); const txt = document.getElementById('gen-text'); const loader = document.getElementById('gen-loader');
            btn.disabled = true; txt.classList.add('invisible'); loader.classList.remove('hidden');

            const time = document.getElementById('ai-time').value;
            const energy = document.getElementById('ai-energy').value;
            const location = document.getElementById('ai-location').value;
            
            let equipment = location === 'Garage' 
                ? "Full Gym: Barbell, Bumper Plates, Pull-up Bar, Bands, Bench, Jump Rope, Running allowed." 
                : "Minimal: Light Kettlebells, Abmat, Medicine Ball.";
                
            if (location === 'Room') {
                equipment += " STRICT CONSTRAINT: SMALL SPACE. NO THROWING (NO WALL BALLS). NO RUNNING. NO JUMP ROPE.";
            }

            // SYSTEM PROMPT: Forces High-Level Structure (Loops) for Cleaner Preview
            const systemPrompt = `
            You are a CrossFit L4 Coach. Create a workout plan in strictly valid JSON format.
            
            STRUCTURE RULES:
            1. DO NOT UNROLL LOOPS. Use the "round" type for circuits.
            2. TYPES allowed:
               - "work": Time-based (e.g., Plank). {type:"work", name:"Plank", duration:60}
               - "rep_work": Rep-based (e.g., Pushups). {type:"rep_work", name:"Pushups", reps:"10"}
               - "rest": Rest interval. {type:"rest", name:"Rest", duration:60}
               - "round": A circuit loop. {type:"round", rounds:3, exercises: [ ...list of work/rep_work/rest... ]}
               - "amrap": Continuous flow for time. {type:"amrap", name:"AMRAP 10", duration:600, exercises: ["5 Pullups", "10 Pushups"]}

            Constraints: Time: ${time} mins. Energy: ${energy}. Equipment: ${equipment}.
            IMPORTANT: For 'warmup' and 'cooldown', use a "round" block or a list of steps. Do NOT just summarize it.
            Output valid JSON array.
            `;

            try {
                // FORCE GEMINI-2.5-FLASH
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "API Server Error");
                }
                
                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                
                const jsonMatch = rawText.match(/\[[\s\S]*\]/);
                if (!jsonMatch) throw new Error("AI response format error. Try again.");
                
                const generatedRoutine = JSON.parse(jsonMatch[0]);

                routines['AI Mission'] = generatedRoutine;
                localStorage.setItem(STORAGE_KEY_ROUTINES, JSON.stringify(routines));
                activeRoutine = routines['AI Mission'];
                
                closeModal('ai-coach-modal');
                renderPreview();
                switchScreen('preview');
                
            } catch (error) {
                console.error(error); 
                alert(`Mission Failed: ${error.message}. \n\nresetting API Key...`);
                localStorage.removeItem(STORAGE_KEY_API);
                location.reload(); 
            } finally {
                btn.disabled = false; txt.classList.remove('invisible'); loader.classList.add('hidden');
            }
        }
        
        // --- PREVIEW RENDERER (Shows High-Level "Rounds") ---
        function renderPreview() {
            els.previewList.innerHTML = '';
            if(!activeRoutine || activeRoutine.length === 0) return;

            activeRoutine.forEach((step, index) => {
                const el = document.createElement('div');
                const isRest = step.type === 'rest';
                const isRound = step.type === 'round';
                
                let borderClass = isRest ? 'border-transparent' : 'border-wolf-accent';
                let bgClass = isRest ? 'bg-transparent' : 'bg-wolf-surface';
                let textClass = isRest ? 'text-wolf-muted' : 'text-white';
                if(isRound) { borderClass = 'border-wolf-pos'; } // Rounds get green border

                el.className = `p-4 rounded-lg border-l-4 ${borderClass} ${bgClass} mb-2`;
                
                let headerText = step.name;
                let subText = "";
                
                if (step.duration > 0) subText = formatTime(step.duration);
                if (step.reps) subText = `${step.reps} Reps`;
                if (isRound) {
                    headerText = `${step.rounds} ROUNDS`;
                    subText = "Circuit";
                }

                let contentHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-[10px] uppercase font-bold tracking-widest text-wolf-muted block mb-1">${step.type.replace('_', ' ')}</span>
                            <h3 class="font-heading text-lg ${textClass} leading-none">${headerText}</h3>
                        </div>
                        <div class="text-right font-bold font-heading text-xl ${textClass}">${subText}</div>
                    </div>
                `;
                
                // If it's a Round or AMRAP, show the nested exercises
                const innerList = step.exercises || [];
                if(innerList.length > 0) {
                    contentHTML += `<ul class="mt-3 space-y-1.5 pl-1 border-t border-white/5 pt-2">`;
                    innerList.forEach(ex => {
                        let name = typeof ex === 'string' ? ex : ex.name;
                        let detail = "";
                        if(typeof ex !== 'string') {
                            if(ex.reps) detail = `(${ex.reps})`;
                            if(ex.duration) detail = `(${formatTime(ex.duration)})`;
                        }
                        contentHTML += `<li class="text-xs text-wolf-muted flex items-center"><span class="w-1 h-1 bg-wolf-muted rounded-full mr-2"></span>${name} <span class="text-wolf-accent ml-1">${detail}</span></li>`;
                    });
                    contentHTML += `</ul>`;
                }
                el.innerHTML = contentHTML;
                els.previewList.appendChild(el);
            });
        }
        
        // --- COMPILER: Unrolls the "Rounds" into Linear Steps for Execution ---
        function compileRoutine(highLevelRoutine) {
            let queue = [];
            highLevelRoutine.forEach(step => {
                if (step.type === 'round' && step.exercises) {
                    // UNROLL LOOP
                    const count = step.rounds || 1;
                    for(let i=0; i<count; i++) {
                        step.exercises.forEach(subStep => {
                            // Clone to avoid reference issues
                            let unrolledStep = {...subStep}; 
                            // Ensure type defaults if missing
                            if(!unrolledStep.type) {
                                if(unrolledStep.reps) unrolledStep.type = 'rep_work';
                                else if(unrolledStep.duration) unrolledStep.type = 'work';
                            }
                            // Add "Round X/Y" label context if needed
                            unrolledStep.roundLabel = `Round ${i+1}/${count}`;
                            queue.push(unrolledStep);
                        });
                    }
                } else {
                    // Push standard step
                    queue.push(step);
                }
            });
            return queue;
        }

        function acceptMission() { goToQuote(); }

        function startWorkoutSession() { 
            initAudio(); 
            // HERE IS THE MAGIC: Compile High-Level -> Linear
            executionQueue = compileRoutine(activeRoutine);
            
            stepIndex = 0; startTime = null; manualRoundCount = 0; 
            els.totalTime.textContent = "--:--"; 
            switchScreen('workout'); 
            startCountdown(); 
        }
        
        function startCountdown() { els.currEx.textContent = ""; els.nextEx.textContent = ""; runStep({ type: 'countdown', duration: 10, name: '' }); }
        function startMissionClock() { startTime = Date.now(); clearInterval(totalInt); totalInt = setInterval(() => { const s = Math.floor((Date.now() - startTime) / 1000); els.totalTime.textContent = formatTime(s); }, 1000); els.totalTime.textContent = "00:00"; }
        
        function runStep(step) {
            clearInterval(timerInt);
            // Progress based on linear queue length
            const pct = (stepIndex / executionQueue.length) * 100; els.bar.style.width = `${pct}%`;
            
            // Status Text (Show Round info if exists)
            let statusStr = step.type === 'countdown' ? 'GET READY' : step.type.toUpperCase().replace('_', ' ');
            if(step.roundLabel) statusStr += ` â€¢ ${step.roundLabel}`;
            els.status.textContent = statusStr;
            
            if (step.type !== 'countdown') {
                els.currEx.textContent = step.name;
                const next = executionQueue[stepIndex + 1]; 
                els.nextEx.textContent = next ? next.name : 'COMPLETE';
            }

            // RESET UI STATE
            els.timed.classList.add('hidden');
            els.manualBtn.classList.add('hidden');
            els.currReps.classList.add('hidden');
            els.amrapContainer.classList.add('hidden');
            els.rep.classList.add('hidden');

            // --- MODE 1: TIMED STEP (Work, Rest, AMRAP) ---
            if (step.duration > 0 || step.type === 'amrap') {
                els.timed.classList.remove('hidden');
                
                // Show list for AMRAPs
                if(step.type === 'amrap') {
                     els.amrapContainer.classList.remove('hidden'); 
                     els.amrapRounds.textContent = manualRoundCount;
                     if(step.exercises) els.apexList.innerHTML = step.exercises.map(e => `<div class="flex items-center text-left"><span class="w-1.5 h-1.5 bg-wolf-accent mr-3 rounded-full flex-shrink-0"></span><span class="text-white">${typeof e === 'string' ? e : e.name}</span></div>`).join('');
                     els.rep.classList.remove('hidden'); 
                }

                let timeLeft = step.duration;
                els.timer.textContent = (timeLeft > 59) ? formatTime(timeLeft) : timeLeft;
                els.timer.style.fontSize = (timeLeft > 99) ? "8rem" : "";
                els.timer.classList.remove('text-wolf-accent');

                timerInt = setInterval(() => {
                    timeLeft--;
                    els.timer.textContent = (timeLeft > 59) ? formatTime(timeLeft) : timeLeft;
                    if (timeLeft <= 3 && timeLeft > 0) { beep('Low'); els.timer.classList.add('text-wolf-accent'); }
                    if (timeLeft <= 0) {
                        clearInterval(timerInt); beep('High');
                        if (step.type === 'countdown') { startMissionClock(); nextStep(); } else { nextStep(); }
                    }
                }, 1000);

            // --- MODE 2: MANUAL REP STEP ---
            } else {
                els.manualBtn.classList.remove('hidden');
                if (step.reps) {
                    els.currReps.textContent = `x ${step.reps}`;
                    els.currReps.classList.remove('hidden');
                }
            }
        }

        function nextStep() { if(els.status.textContent !== 'GET READY') stepIndex++; if (stepIndex >= executionQueue.length) { finishWorkout(); return; } runStep(executionQueue[stepIndex]); }
        window.incrementRound = () => { manualRoundCount++; els.amrapRounds.textContent = manualRoundCount; beep('Mid'); };
        els.manualBtn.addEventListener('click', () => { beep('Mid'); nextStep(); });
        
        function finishWorkout() { clearInterval(totalInt); beep('High'); els.finalTime.textContent = document.getElementById('total-time-display').textContent; switchScreen('completion'); }
        function formatTime(s) { const min = Math.floor(s / 60).toString().padStart(2, '0'); const sec = (s % 60).toString().padStart(2, '0'); return `${min}:${sec}`; }
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function beep(type) { if (!audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); const freqs = { 'Low': 150, 'Mid': 400, 'High': 800 }; osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.value = freqs[type]; osc.type = 'triangle'; gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3); }
        function switchScreen(name) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[name].classList.add('active'); }
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden'); window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.goToMenu = () => { clearInterval(timerInt); clearInterval(totalInt); switchScreen('menu'); };
        function goToQuote() { const quotes = [{q: "The wolf on the hill is not as hungry as the wolf climbing the hill.", a: "Arnold"}, {q: "I don't stop when I'm tired. I stop when I'm done.", a: "Goggins"}, {q: "Civilize the mind, but make savage the body.", a: "Mao"}]; const rnd = quotes[Math.floor(Math.random() * quotes.length)]; document.getElementById('quote-text').textContent = `"${rnd.q}"`; document.getElementById('quote-author').textContent = rnd.a; switchScreen('quote'); }
    </script>
</body>
</html>
