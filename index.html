<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOLF ALPHA 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    
    <meta name="theme-color" content="#1c1917">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/292524/d6d3d1?text=W" sizes="180x180">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wolf: {
                            bg: '#0c0a09',      
                            surface: '#1c1917', 
                            border: '#44403c',  
                            text: '#e7e5e4',    
                            accent: '#b45309',  
                            accentHover: '#92400e',
                            muted: '#78716c',
                            pos: '#15803d',
                            neg: '#991b1b',
                            mid: '#854d0e',
                        }
                    },
                    fontFamily: {
                        heading: ['Oswald', 'sans-serif'],
                        body: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0c0a09;
            color: #e7e5e4;
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        h1, h2, h3, .font-heading { font-family: 'Oswald', sans-serif; }
        .screen { display: none; }
        .active { display: flex; }
        
        .btn-primary {
            background-color: #b45309;
            color: white;
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.2s;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .btn-primary:active { transform: translateY(1px); }
        .btn-primary:hover { background-color: #92400e; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            background-color: #292524;
            border: 1px solid #44403c;
            color: #d6d3d1;
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-secondary:active { transform: translateY(1px); }
        .btn-secondary:hover { border-color: #78716c; color: white; }
        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .tool-input {
            background: transparent;
            border: 2px solid #44403c;
            color: white;
            text-align: center;
            font-family: 'Oswald', sans-serif;
            border-radius: 0.5rem;
        }
        .tool-input:focus { border-color: #b45309; outline: none; }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0c0a09; }
        ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 3px; }
        
        #mic-wave {
            display: none;
        }
        #mic-wave.listening {
            display: flex;
        }
        .bar {
            width: 4px;
            height: 10px;
            background: #b45309;
            margin: 0 2px;
            animation: wave 0.5s infinite ease-in-out alternate;
        }
        .bar:nth-child(2) { animation-delay: 0.1s; }
        .bar:nth-child(3) { animation-delay: 0.2s; }
        .bar:nth-child(4) { animation-delay: 0.3s; }
        @keyframes wave { to { height: 25px; } }

    </style>
</head>
<body class="h-screen overflow-hidden selection:bg-wolf-accent selection:text-white">

    <div id="sync-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-wolf-surface border border-wolf-border p-6 w-full max-w-md rounded-xl shadow-2xl">
            <h2 class="font-heading text-2xl text-wolf-accent mb-2 tracking-wide">CLOUD SYNC</h2>
            <p class="text-wolf-muted text-sm mb-4">
                System status: <span id="modal-status" class="text-white font-bold">CHECKING...</span>
            </p>
            <div class="flex gap-3 mt-4">
                <button onclick="closeModal('sync-modal')" class="flex-1 py-3 btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <div id="weight-modal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-wolf-surface border border-wolf-border p-6 w-full max-w-sm rounded-xl shadow-2xl text-center">
            <h2 class="font-heading text-3xl text-wolf-accent mb-6">WEIGHT CHECK</h2>
            
            <div class="flex items-center justify-center gap-2 mb-8">
                <input type="number" step="0.1" id="weight-input" placeholder="000.0" class="bg-transparent border-b-2 border-wolf-muted text-center text-5xl text-white w-48 focus:border-wolf-accent outline-none font-heading" inputmode="decimal">
                <span class="text-wolf-muted text-xl font-bold mt-4">LBS</span>
            </div>

            <button onclick="saveWeightEntry()" id="save-weight-btn" class="w-full btn-primary py-4 text-xl">LOG WEIGHT</button>
            <button onclick="closeModal('weight-modal')" class="mt-4 text-wolf-muted text-xs uppercase tracking-widest hover:text-white">Cancel</button>
        </div>
    </div>

    <div id="checkin-modal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-wolf-surface border border-wolf-border p-6 w-full max-w-md rounded-xl shadow-2xl">
            <h2 class="font-heading text-3xl text-wolf-accent mb-6 text-center">END OF DAY CHECK</h2>
            <div id="checkin-questions-container" class="space-y-4 mb-8">
                </div>
            <button onclick="saveDailyCheckin()" class="w-full btn-primary py-4 text-xl">CONFIRM CHECK-IN</button>
            <button onclick="closeModal('checkin-modal')" class="mt-4 w-full text-wolf-muted text-xs uppercase tracking-widest hover:text-white text-center">Cancel</button>
        </div>
    </div>

    <div id="checkin-manager-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-wolf-surface border border-wolf-border p-6 w-full max-w-md rounded-xl flex flex-col max-h-[90vh]">
            <h2 class="font-heading text-2xl text-wolf-accent mb-6 tracking-wide text-center">MANAGE DAILY TASKS</h2>
            <div class="flex gap-2 mb-6 border-b border-wolf-border pb-6">
                <input type="text" id="new-checkin-item" placeholder="Add new task..." class="flex-1 bg-wolf-bg border border-wolf-border text-white px-4 py-2 rounded text-sm focus:border-wolf-accent outline-none">
                <button onclick="addCheckinItem()" class="btn-primary px-4 py-2 text-xl font-bold">+</button>
            </div>
            <div id="checkin-manager-list" class="flex-grow overflow-y-auto space-y-3 pr-1"></div>
            <button onclick="closeModal('checkin-manager-modal')" class="mt-6 text-wolf-muted hover:text-white uppercase text-xs tracking-widest text-center">Close</button>
        </div>
    </div>

    <div id="activity-modal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-wolf-surface border border-wolf-border p-5 w-full max-w-md rounded-xl shadow-2xl flex flex-col max-h-[95vh] overflow-y-auto">
            <h2 id="act-modal-title" class="font-heading text-2xl text-wolf-accent mb-4">LOG ACTIVITY</h2>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Activity</label>
                    <input type="text" id="act-name" placeholder="e.g. Workout, Reading, Sleep" class="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none">
                </div>
                
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Time</label>
                        <input type="datetime-local" id="act-time" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 text-xs rounded focus:border-wolf-accent outline-none">
                    </div>
                    <div class="w-1/3">
                        <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Amount</label>
                        <input type="text" id="act-amount" placeholder="Qty" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 rounded text-sm focus:border-wolf-accent outline-none">
                    </div>
                     <div class="w-1/4">
                        <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Unit</label>
                        <input type="text" id="act-unit" placeholder="mins" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 rounded text-sm focus:border-wolf-accent outline-none">
                    </div>
                </div>

                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Rating</label>
                        <select id="act-rating" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 rounded text-sm form-select focus:border-wolf-accent outline-none">
                            <option value="Neutral">Neutral</option>
                            <option value="Positive">Positive</option>
                            <option value="Negative">Negative</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Focus</label>
                        <select id="act-focus" class="w-full bg-wolf-bg border border-wolf-border text-white p-2 rounded text-sm form-select focus:border-wolf-accent outline-none">
                            <option value="None">None</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Note</label>
                    <textarea id="act-note" rows="3" placeholder="Details..." class="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none"></textarea>
                </div>
            </div>

            <button onclick="saveActivityLog()" id="save-act-btn" class="w-full btn-primary py-4 text-xl mt-6">CONFIRM LOG</button>
            <button onclick="closeModal('activity-modal')" class="mt-4 text-wolf-muted text-xs uppercase tracking-widest hover:text-white text-center">Cancel</button>
        </div>
    </div>

    <div id="tools-screen" class="screen h-full w-full flex-col bg-wolf-bg p-4">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-wolf-border">
            <h2 class="font-heading text-3xl text-wolf-text">TOOLS</h2>
            <button onclick="switchScreen('menu')" class="btn-secondary px-4 py-2 text-sm">Exit</button>
        </div>
        
        <div class="flex gap-2 mb-6">
            <button onclick="switchTool('stopwatch')" id="tab-stopwatch" class="flex-1 py-2 rounded text-xs uppercase font-bold bg-wolf-accent text-white transition">Stopwatch</button>
            <button onclick="switchTool('timer')" id="tab-timer" class="flex-1 py-2 rounded text-xs uppercase font-bold bg-wolf-surface text-wolf-muted hover:text-white transition">Timer</button>
            <button onclick="switchTool('tabata')" id="tab-tabata" class="flex-1 py-2 rounded text-xs uppercase font-bold bg-wolf-surface text-wolf-muted hover:text-white transition">Tabata</button>
        </div>

        <div id="tool-stopwatch" class="flex-grow flex flex-col items-center justify-start text-center pt-10">
            <div id="sw-status" class="hidden text-wolf-accent uppercase tracking-widest text-2xl mb-2 font-heading animate-pulse">GET READY</div>
            <div id="sw-display" class="font-heading text-7xl md:text-9xl text-white mb-4 tabular-nums">00:00.0</div>
            <div class="flex gap-4 w-full max-w-md mb-6">
                <button onclick="toggleStopwatch()" id="sw-btn" class="flex-1 btn-primary py-4 text-xl">START</button>
                <button onclick="lapStopwatch()" id="sw-lap-btn" class="flex-1 btn-secondary py-4 text-xl disabled:opacity-50">LAP</button>
            </div>
            <div class="flex items-center gap-2 mb-8">
                <input type="checkbox" id="sw-countdown-check" class="w-5 h-5 accent-wolf-accent cursor-pointer">
                <label for="sw-countdown-check" class="text-xs uppercase text-wolf-muted font-bold cursor-pointer">10 Sec Countdown</label>
            </div>
            <div id="sw-laps" class="w-full max-w-md h-40 overflow-y-auto bg-wolf-surface border border-wolf-border rounded-lg p-2 text-sm space-y-1">
                <div class="text-wolf-muted text-center italic py-2">Laps will appear here</div>
            </div>
             <button onclick="resetStopwatch()" class="mt-4 text-wolf-muted text-xs uppercase tracking-widest hover:text-white">Reset All</button>
        </div>

        <div id="tool-timer" class="hidden flex-grow flex flex-col items-center justify-start text-center pt-10">
            <div id="tm-config-container" class="flex flex-col items-center">
                <div class="flex gap-4 items-center mb-8">
                    <div class="flex flex-col">
                        <label class="text-[10px] uppercase text-wolf-muted mb-1 tracking-widest">Hours</label>
                        <input type="number" id="tm-h" placeholder="00" class="tool-input w-20 text-4xl p-2" min="0" max="99">
                    </div>
                    <span class="text-2xl text-wolf-muted mt-4">:</span>
                    <div class="flex flex-col">
                        <label class="text-[10px] uppercase text-wolf-muted mb-1 tracking-widest">Mins</label>
                        <input type="number" id="tm-m" placeholder="00" class="tool-input w-20 text-4xl p-2" min="0" max="59">
                    </div>
                    <span class="text-2xl text-wolf-muted mt-4">:</span>
                    <div class="flex flex-col">
                        <label class="text-[10px] uppercase text-wolf-muted mb-1 tracking-widest">Secs</label>
                        <input type="number" id="tm-s" placeholder="00" class="tool-input w-20 text-4xl p-2" min="0" max="59">
                    </div>
                </div>

                <div class="flex items-center gap-3 mb-10 bg-wolf-surface px-4 py-2 rounded-lg border border-wolf-border">
                    <input type="checkbox" id="tm-rounds-check" class="w-5 h-5 accent-wolf-accent cursor-pointer">
                    <label for="tm-rounds-check" class="text-sm uppercase font-bold text-wolf-muted cursor-pointer select-none">Track Rounds</label>
                </div>
            </div>

            <div id="tm-status" class="hidden text-wolf-accent uppercase tracking-widest text-2xl mb-2 font-heading animate-pulse">GET READY</div>
            <div id="tm-display" class="hidden font-heading text-7xl md:text-9xl text-white mb-4 tabular-nums">00:00</div>
            
            <div id="tm-round-tracker" class="hidden mb-6 flex flex-col items-center animate-in fade-in">
                 <p class="text-wolf-muted uppercase text-[10px] tracking-widest mb-2">Round Counter</p>
                 <div class="flex items-center gap-6">
                    <div id="tm-rounds-val" class="font-heading text-5xl text-white">0</div>
                    <button onclick="toolIncrementRound()" class="btn-secondary px-4 py-2 text-lg font-bold border-wolf-accent text-wolf-accent hover:bg-wolf-accent hover:text-white">+ ROUND</button>
                 </div>
            </div>

            <div class="flex gap-4 w-full max-w-md mb-6">
                <button onclick="toggleTimer()" id="tm-btn" class="flex-1 btn-primary py-4 text-xl">START</button>
                <button onclick="resetTimer()" class="flex-1 btn-secondary py-4 text-xl">RESET</button>
            </div>
            
            <div class="flex items-center gap-2">
                <input type="checkbox" id="tm-countdown-check" class="w-5 h-5 accent-wolf-accent cursor-pointer">
                <label for="tm-countdown-check" class="text-xs uppercase text-wolf-muted font-bold cursor-pointer">10 Sec Countdown</label>
            </div>
        </div>

        <div id="tool-tabata" class="hidden flex-grow flex flex-col items-center justify-center text-center">
            <div id="tb-config" class="w-full max-w-sm space-y-4 mb-8">
                <div class="flex justify-between items-center">
                    <label class="text-wolf-muted uppercase text-sm font-bold">Work (Sec)</label>
                    <input type="number" id="tb-work" value="20" class="tool-input w-24 text-2xl p-1">
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-wolf-muted uppercase text-sm font-bold">Rest (Sec)</label>
                    <input type="number" id="tb-rest" value="10" class="tool-input w-24 text-2xl p-1">
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-wolf-muted uppercase text-sm font-bold">Rounds</label>
                    <input type="number" id="tb-rounds" value="8" class="tool-input w-24 text-2xl p-1">
                </div>
            </div>
            <div id="tb-display-container" class="hidden">
                <p id="tb-status" class="text-wolf-accent uppercase tracking-widest text-2xl mb-2 font-heading">WORK</p>
                <div id="tb-timer" class="font-heading text-8xl md:text-9xl text-white mb-2 tabular-nums">20</div>
                <p id="tb-round-counter" class="text-wolf-muted uppercase tracking-widest text-2xl font-bold">Round 1/8</p>
            </div>
            <button onclick="toggleTabata()" id="tb-btn" class="w-full max-w-sm btn-primary py-4 text-xl mt-6">START TABATA</button>
            
            <div id="tb-countdown-container" class="flex items-center justify-center gap-2 mt-4">
                <input type="checkbox" id="tb-countdown-check" class="w-5 h-5 accent-wolf-accent cursor-pointer" checked>
                <label for="tb-countdown-check" class="text-xs uppercase text-wolf-muted font-bold cursor-pointer">10 Sec Countdown</label>
            </div>
        </div>
    </div>

    <div id="list-screen" class="screen h-full w-full flex-col bg-wolf-bg p-4">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-wolf-border">
            <h2 class="font-heading text-3xl text-wolf-text">PROTOCOLS</h2>
            <button onclick="switchScreen('menu')" class="btn-secondary px-4 py-2 text-sm">Back</button>
        </div>
        <div id="workout-list-container" class="flex-grow overflow-y-auto space-y-3 pb-20"></div>
    </div>

    <div id="editor-select-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-wolf-surface border border-wolf-border p-6 w-full max-w-md rounded-xl flex flex-col max-h-[90vh]">
            <h2 class="font-heading text-2xl text-wolf-accent mb-6 tracking-wide text-center">MANAGE PROTOCOLS</h2>
            <div class="flex gap-2 mb-6 border-b border-wolf-border pb-6">
                <input type="text" id="new-workout-name" placeholder="New Protocol Name" class="flex-1 bg-wolf-bg border border-wolf-border text-white px-4 py-2 rounded text-sm focus:border-wolf-accent outline-none">
                <button onclick="createNewWorkout()" class="btn-primary px-4 py-2 text-xl font-bold">+</button>
            </div>
            <div id="manager-list" class="flex-grow overflow-y-auto space-y-3 pr-1"></div>
            <button onclick="closeModal('editor-select-modal')" class="mt-6 text-wolf-muted hover:text-white uppercase text-xs tracking-widest text-center">Close Manager</button>
        </div>
    </div>

    <div id="editor-screen" class="screen h-full w-full flex-col bg-wolf-bg p-4">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-wolf-border">
            <h2 id="editor-title" class="font-heading text-3xl text-wolf-text truncate max-w-[50%]">EDIT</h2>
            <div class="flex gap-2 shrink-0">
                <button onclick="saveRoutineChanges()" class="btn-primary px-4 py-2 text-sm">Save</button>
                <button onclick="switchScreen('menu')" class="btn-secondary px-4 py-2 text-sm">Exit</button>
            </div>
        </div>
        <div id="editor-content" class="flex-grow overflow-y-auto space-y-3 pb-20"></div>
        <div class="pt-4 border-t border-wolf-border">
            <button onclick="addStepToEditor()" class="w-full py-3 border border-dashed border-wolf-muted text-wolf-muted hover:text-white hover:border-white rounded-lg uppercase text-sm tracking-widest transition">+ Add Exercise</button>
        </div>
    </div>

    <div id="menu-screen" class="screen active h-full w-full flex-col items-center justify-center p-6 relative">
        <button onclick="openModal('sync-modal')" class="absolute top-6 right-6 text-wolf-muted hover:text-wolf-accent transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </button>

        <div class="z-10 text-center w-full max-w-sm flex flex-col items-center">
            <h1 class="font-heading text-6xl text-wolf-text tracking-tight mb-2">WOLF<span class="text-wolf-accent">ALPHA</span></h1>
            <p class="text-wolf-muted text-sm uppercase tracking-[0.3em] mb-8">Conquer Your Day</p>

            <div class="w-full space-y-3 mb-6">
                 <button onclick="switchScreen('list')" class="w-full btn-primary py-4 text-xl shadow-lg shadow-orange-900/20">WORKOUTS</button>
                 <button onclick="openCheckinModal()" class="w-full btn-primary py-4 text-xl shadow-lg shadow-orange-900/10 border border-wolf-accent/30">DAILY CHECK-IN</button>
                 
                 <div class="flex gap-3">
                    <button onclick="toggleVoiceInput()" class="w-1/4 btn-secondary py-4 flex items-center justify-center text-wolf-accent border-wolf-accent relative group overflow-hidden">
                        <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                        <div id="mic-wave" class="absolute inset-0 flex items-center justify-center opacity-50 z-0">
                            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                        </div>
                    </button>
                    <button onclick="openActivityModal('manual')" class="flex-grow btn-secondary py-4 text-lg">LOG ACTIVITY</button>
                 </div>
            </div>

            <div class="w-full space-y-3 pt-3 border-t border-wolf-border">
                 <div class="grid grid-cols-2 gap-3 mt-2">
                    <button onclick="openApexConfig()" class="btn-secondary py-3 text-[10px] tracking-widest text-wolf-muted hover:text-white uppercase font-bold">Apex</button>
                    <button onclick="showHistory()" class="btn-secondary py-3 text-[10px] tracking-widest text-wolf-muted uppercase font-bold">History</button>
                    <button onclick="switchScreen('tools')" class="btn-secondary py-3 text-[10px] tracking-widest text-wolf-muted uppercase font-bold">Tools</button>
                    <button onclick="openManager()" class="btn-secondary py-3 text-[10px] tracking-widest text-wolf-muted uppercase font-bold">Edit Pgm</button>
                    <button onclick="openCheckinManager()" class="btn-secondary py-3 text-[10px] tracking-widest text-wolf-muted uppercase font-bold">Edit Tasks</button>
                    <button onclick="openModal('weight-modal')" class="btn-secondary py-3 text-[10px] tracking-widest text-wolf-muted uppercase font-bold">Log Weight</button>
                </div>
            </div>
            
            <div id="sync-status" class="mt-6 text-[10px] text-wolf-muted uppercase tracking-widest opacity-50">Connecting...</div>
        </div>
    </div>

    <div id="apex-config-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-wolf-surface border border-wolf-border p-8 w-full max-w-sm rounded-xl text-center shadow-2xl">
            <h2 class="font-heading text-4xl text-wolf-accent mb-6">APEX CONFIG</h2>
            <div class="mb-6 text-left">
                <label class="block text-wolf-muted text-xs font-bold mb-2 uppercase tracking-wide">Ladder Peak (Reps)</label>
                <div class="flex items-center bg-wolf-bg rounded-lg border border-wolf-border">
                    <button onclick="adjustRep(-1)" class="p-4 text-wolf-muted hover:text-white transition text-xl">-</button>
                    <input type="number" id="apex-max-reps" value="8" class="flex-1 bg-transparent text-white text-3xl p-2 text-center font-heading focus:outline-none">
                    <button onclick="adjustRep(1)" class="p-4 text-wolf-muted hover:text-white transition text-xl">+</button>
                </div>
            </div>
            <div class="mb-8 text-left">
                <label class="block text-wolf-muted text-xs font-bold mb-2 uppercase tracking-wide">Weight Load</label>
                <input type="text" id="apex-weight" placeholder="e.g. 35lbs" class="w-full bg-wolf-bg border border-wolf-border text-white text-xl p-3 text-center font-heading rounded-lg outline-none focus:border-wolf-accent">
            </div>
            <div class="flex gap-3">
                <button onclick="closeModal('apex-config-modal')" class="flex-1 py-3 btn-secondary">Cancel</button>
                <button onclick="confirmApexStart()" class="flex-1 py-3 btn-primary">Start</button>
            </div>
        </div>
    </div>

    <div id="quote-screen" class="screen min-h-screen w-full flex-col items-center justify-center p-8 text-center bg-wolf-bg">
        <div class="z-10 max-w-2xl">
            <div class="w-16 h-1 bg-wolf-accent mx-auto mb-8 rounded-full"></div>
            <blockquote id="quote-text" class="font-heading text-3xl md:text-5xl text-wolf-text leading-tight opacity-90"></blockquote>
            <cite id="quote-author" class="block text-wolf-muted font-bold text-sm mt-6 uppercase tracking-widest"></cite>
        </div>
        <button id="start-btn" class="z-10 mt-16 btn-primary py-4 px-12 text-2xl shadow-xl shadow-orange-900/10">BEGIN</button>
    </div>

    <div id="workout-screen" class="screen h-full w-full flex-col relative bg-wolf-bg">
        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-20">
            <div>
                <span class="text-wolf-muted text-[10px] uppercase tracking-widest block">Elapsed</span>
                <span id="total-time-display" class="font-heading text-2xl text-wolf-text">--:--</span>
            </div>
            <button onclick="goToMenu()" class="text-wolf-muted hover:text-white text-xs font-bold uppercase tracking-widest px-3 py-1 border border-transparent hover:border-wolf-muted rounded transition">Exit</button>
        </div>

        <div class="flex-grow flex flex-col items-center justify-center p-4 z-10 w-full max-w-4xl mx-auto mt-10">
            <div class="w-full bg-wolf-surface h-1.5 mb-12 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-wolf-accent h-full transition-all duration-300 rounded-full" style="width: 0%"></div>
            </div>

            <p id="status-text" class="font-heading text-3xl text-wolf-accent uppercase tracking-widest mb-2 animate-pulse">Prepare</p>
            <p id="current-exercise" class="text-4xl md:text-7xl font-bold text-white mb-8 text-center leading-none tracking-tight"></p>
            
            <div id="timed-content" class="w-full text-center">
                <div id="timer-display" class="font-heading text-[8rem] md:text-[14rem] text-wolf-text leading-none select-none tabular-nums">10</div>
                
                <div id="amrap-counter-container" class="hidden mt-6 flex flex-col items-center animate-in fade-in slide-in-from-bottom-4">
                    <p class="text-wolf-muted uppercase text-xs tracking-widest mb-2">Round Tracker</p>
                    <div class="flex items-center gap-6">
                        <div id="amrap-rounds" class="font-heading text-6xl text-white">0</div>
                        <button onclick="incrementRound()" class="btn-secondary px-6 py-4 text-xl font-bold border-wolf-accent text-wolf-accent hover:bg-wolf-accent hover:text-white">+ ROUND</button>
                    </div>
                </div>

                <button id="manual-next-btn" class="hidden mt-8 btn-primary px-10 py-4 text-xl mx-auto">Next</button>
            </div>

            <div id="rep-content" class="hidden w-full text-center max-w-xl">
                <div id="apex-exercise-list" class="text-left text-lg font-medium mb-10 space-y-3 bg-wolf-surface p-6 rounded-xl border border-wolf-border"></div>
                <button id="round-complete-btn" class="btn-primary w-full md:w-auto px-16 py-5 text-2xl">Complete</button>
            </div>
        </div>
        
        <div class="p-6 z-20 pb-10 text-center">
            <span class="text-wolf-muted text-[10px] uppercase tracking-widest block mb-1">Up Next</span>
            <span id="next-exercise" class="text-wolf-text text-xl font-heading uppercase"></span>
        </div>
    </div>

    <div id="completion-screen" class="screen min-h-screen w-full flex-col items-center justify-center p-6 text-center bg-wolf-bg">
        <h2 class="font-heading text-5xl md:text-8xl text-wolf-accent mb-2">COMPLETE</h2>
        <p class="text-wolf-muted uppercase tracking-widest mb-12 text-sm">Well Done</p>
        
        <div class="bg-wolf-surface border border-wolf-border p-8 w-full max-w-sm mb-10 rounded-xl">
            <p class="text-wolf-muted text-[10px] uppercase tracking-widest mb-1">Total Time</p>
            <p id="final-time-display" class="text-6xl text-white font-heading my-2">--:--</p>
            <div id="final-stats-extra" class="mt-6 pt-6 border-t border-wolf-border text-left hidden"></div>
        </div>
        
        <div class="flex flex-col gap-3 w-full max-w-sm">
             <button onclick="logWorkoutToActivity()" class="btn-primary w-full py-4 text-lg">LOG DETAILS</button>
             <button onclick="goToMenu()" class="btn-secondary w-full py-4 text-lg">DISCARD & EXIT</button>
        </div>
    </div>

    <div id="history-screen" class="screen min-h-screen w-full flex-col p-6 bg-wolf-bg">
        <div class="max-w-2xl mx-auto w-full flex flex-col h-full">
            <div class="flex items-center justify-between mb-8 pb-4 border-b border-wolf-border">
                <h2 class="font-heading text-3xl text-wolf-text">HISTORY</h2>
                <button onclick="goToMenu()" class="text-wolf-muted hover:text-white text-xs uppercase font-bold tracking-widest">Back</button>
            </div>
            <div id="history-loading" class="hidden text-center text-wolf-accent animate-pulse mt-10 text-sm tracking-widest uppercase">Syncing...</div>
            <div id="history-list" class="flex-grow overflow-y-auto space-y-3 pb-20"></div>
            <div id="no-history-msg" class="hidden text-center text-wolf-muted mt-20 text-sm">No activity recorded yet.</div>
        </div>
    </div>

    <script>
        // --------------------------------------------------------------
        // >>> ACTION REQUIRED: PASTE YOUR GOOGLE SCRIPT URL BELOW <<<
        const HARDCODED_URL = "https://script.google.com/macros/s/AKfycbxx2iCp9PgKa2XcY_zZuhvCjN0BeCrthAa93OjHPNDpRr9zXgozhpKi9zZcoEfjGHl6/exec"; 
        // --------------------------------------------------------------

        const STORAGE_KEY_HIST = 'wolf_history';
        const STORAGE_KEY_ROUTINES = 'wolf_routines';
        const STORAGE_KEY_CHECKINS = 'wolf_daily_items';
        
        // DEFAULT DATA
        const defaultRoutines = {
            'Wake Up': [
                { type: 'work', name: 'Bounce & Breathe', duration: 60 },
                { type: 'rep_work', name: 'Shoulder Pinches', exercises: ['10 Reps'] },
                { type: 'rep_work', name: 'Arm Circles', exercises: ['10 Fwd / 10 Bwd'] },
                { type: 'rep_work', name: 'Hip Bridges', exercises: ['10 Reps + Hold'] },
                { type: 'rep_work', name: 'Windshield Wipers', exercises: ['10 Reps'] },
                { type: 'rep_work', name: 'Cat-Cow', exercises: ['10 Reps'] },
                { type: 'cooldown', name: "Child's Pose", duration: 60 }
            ],
            'Morning Grind': [
                { type: 'work', name: 'Push-ups', round: '1/4', duration: 40 }, { type: 'rest', name: 'Shake It Out', duration: 15 },
                { type: 'work', name: 'Push-ups', round: '2/4', duration: 40 }, { type: 'rest', name: 'Shake It Out', duration: 15 },
                { type: 'work', name: 'Push-ups', round: '3/4', duration: 40 }, { type: 'rest', name: 'Recover', duration: 45 },
                { type: 'work', name: 'Air Squats', round: '1/4', duration: 40 }, { type: 'rest', name: 'Shake It Out', duration: 15 },
                { type: 'work', name: 'Air Squats', round: '2/4', duration: 40 }, { type: 'rest', name: 'Recover', duration: 45 },
                { type: 'work', name: 'Burpees', round: '1/4', duration: 40 }, { type: 'rest', name: 'Shake It Out', duration: 15 },
                { type: 'work', name: 'Burpees', round: '2/4', duration: 40 }, { type: 'rest', name: 'Recover', duration: 45 },
                { type: 'work', name: 'Mountain Climbers', duration: 45 },
                { type: 'cooldown', name: 'Stretch', duration: 60 }
            ],
            apex_config: {
                exercises: ['KB Swings', 'Front Squats', 'Shoulder Press', 'Row', 'Push-Ups'],
                restTime: 30
            },
            'Garage Games': [
                 { type: "amrap", name: "AMRAP 20", duration: 1200, round: "See List Below", exercises: ["10 Med Ball Cleans", "10 Pull-Ups", "40 Double Unders"] }
            ]
        };

        let routines = JSON.parse(localStorage.getItem(STORAGE_KEY_ROUTINES)) || JSON.parse(JSON.stringify(defaultRoutines));
        let checkinItems = JSON.parse(localStorage.getItem(STORAGE_KEY_CHECKINS)) || ["Read Bible", "Bed by 2200"];

        const screens = {
            menu: document.getElementById('menu-screen'),
            quote: document.getElementById('quote-screen'),
            workout: document.getElementById('workout-screen'),
            completion: document.getElementById('completion-screen'),
            history: document.getElementById('history-screen'),
            editor: document.getElementById('editor-screen'),
            tools: document.getElementById('tools-screen'),
            list: document.getElementById('list-screen')
        };
        const els = {
            timer: document.getElementById('timer-display'),
            currEx: document.getElementById('current-exercise'),
            nextEx: document.getElementById('next-exercise'),
            status: document.getElementById('status-text'),
            bar: document.getElementById('progress-bar'),
            timed: document.getElementById('timed-content'),
            rep: document.getElementById('rep-content'),
            manualBtn: document.getElementById('manual-next-btn'),
            apexList: document.getElementById('apex-exercise-list'),
            totalTime: document.getElementById('total-time-display'),
            finalTime: document.getElementById('final-time-display'),
            syncStatus: document.getElementById('sync-status'),
            modalStatus: document.getElementById('modal-status'),
            workoutList: document.getElementById('workout-list-container'),
            managerList: document.getElementById('manager-list'),
            newWorkoutName: document.getElementById('new-workout-name'),
            amrapContainer: document.getElementById('amrap-counter-container'),
            amrapRounds: document.getElementById('amrap-rounds'),
            // Tools
            tmRoundTracker: document.getElementById('tm-round-tracker'),
            tmRoundVal: document.getElementById('tm-rounds-val'),
            swLaps: document.getElementById('sw-laps'),
            swStatus: document.getElementById('sw-status'),
            tmStatus: document.getElementById('tm-status')
        };

        let currentWorkoutType = null;
        let activeRoutine = [];
        let stepIndex = 0;
        let timerInt = null;
        let totalInt = null;
        let startTime = null;
        let audioCtx;
        let editingRoutineKey = null;
        let editingCopy = null;
        let manualRoundCount = 0;
        let completedWorkoutStats = {};

        // Tool Vars
        let toolInt = null;
        let swTime = 0;
        let swLastLapTime = 0; 
        let tmTime = 0;
        let tmOriginalTime = 0; 
        let tbState = { round: 1, isWork: false, timeLeft: 0, totalRounds: 8, workTime: 20, restTime: 10, active: false };
        let toolRoundCount = 0;
        let isPrep = false;
        
        let editingHistoryId = null;
        let recognition;
        let isRecording = false; 
        let finalTranscript = ""; 

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            initSync();
            renderMenuWorkouts();
            document.getElementById('start-btn').addEventListener('click', startWorkoutSession);
            setupSpeechRecognition();
        });

        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true; 
                recognition.lang = 'en-US';
                recognition.interimResults = false;

                recognition.onstart = () => { document.getElementById('mic-wave').classList.add('listening'); };
                recognition.onend = () => { 
                    if (isRecording) { try { recognition.start(); } catch(e) { isRecording = false; document.getElementById('mic-wave').classList.remove('listening'); if(finalTranscript.trim()) parseVoiceInput(finalTranscript); } } 
                    else { document.getElementById('mic-wave').classList.remove('listening'); if(finalTranscript.trim()) { parseVoiceInput(finalTranscript); } finalTranscript = ""; }
                };
                recognition.onresult = (event) => { for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) { finalTranscript += event.results[i][0].transcript + " "; } } };
            } else { document.getElementById('mic-icon').style.opacity = '0.3'; }
        }

        // --- SYNC LOGIC ---
        function initSync() {
            if(HARDCODED_URL && HARDCODED_URL.startsWith('http')) {
                els.syncStatus.textContent = "CLOUD ACTIVE"; els.syncStatus.classList.add('text-wolf-accent');
                els.modalStatus.textContent = "CONNECTED"; els.modalStatus.classList.add('text-green-500');
                syncRoutines();
            } else { els.syncStatus.textContent = "LOCAL MODE"; els.modalStatus.textContent = "NOT CONNECTED"; els.modalStatus.classList.add('text-red-500'); }
        }
        function getApiUrl() { return (HARDCODED_URL && HARDCODED_URL.startsWith('http')) ? HARDCODED_URL : null; }

        // --- DYNAMIC MENU ---
        function renderMenuWorkouts() {
            els.workoutList.innerHTML = '';
            Object.keys(routines).forEach(key => {
                if(key === 'apex_config') return;
                const btn = document.createElement('button');
                btn.className = "w-full btn-secondary py-4 text-lg";
                if(key === 'Morning Grind') btn.className = "w-full btn-primary py-4 text-xl shadow-lg shadow-orange-900/20";
                btn.textContent = key;
                btn.onclick = () => selectWorkout(key);
                els.workoutList.appendChild(btn);
            });
        }

        // --- DAILY CHECK-IN LOGIC (NEW) ---
        function openCheckinModal() {
            const container = document.getElementById('checkin-questions-container');
            container.innerHTML = '';
            checkinItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "bg-wolf-bg p-4 rounded-lg border border-wolf-border flex justify-between items-center";
                div.innerHTML = `
                    <span class="text-white text-sm font-bold uppercase tracking-wide">${item}?</span>
                    <div class="flex gap-2">
                        <input type="radio" name="check-${index}" id="yes-${index}" value="Yes" class="hidden peer/yes" checked>
                        <label for="yes-${index}" class="px-4 py-2 border border-wolf-border rounded text-[10px] font-bold peer-checked/yes:bg-wolf-pos peer-checked/yes:border-wolf-pos cursor-pointer transition">YES</label>
                        <input type="radio" name="check-${index}" id="no-${index}" value="No" class="hidden peer/no">
                        <label for="no-${index}" class="px-4 py-2 border border-wolf-border rounded text-[10px] font-bold peer-checked/no:bg-wolf-neg peer-checked/no:border-wolf-neg cursor-pointer transition">NO</label>
                    </div>
                `;
                container.appendChild(div);
            });
            openModal('checkin-modal');
        }

        async function saveDailyCheckin() {
            const results = [];
            checkinItems.forEach((item, index) => {
                const val = document.querySelector(`input[name="check-${index}"]:checked`).value;
                results.push(`${item}: ${val}`);
            });
            const entry = {
                date: new Date().toISOString(), type: "Daily Check-In", duration: "Check-in",
                details: { notes: results.join(' | '), rating: "Positive" }
            };
            const h = JSON.parse(localStorage.getItem(STORAGE_KEY_HIST)) || [];
            h.push(entry);
            localStorage.setItem(STORAGE_KEY_HIST, JSON.stringify(h));
            await syncEntryToCloud(entry, 'create');
            closeModal('checkin-modal'); alert("Log recorded.");
            if(screens.history.classList.contains('active')) showHistory();
        }

        function openCheckinManager() {
            const list = document.getElementById('checkin-manager-list');
            list.innerHTML = '';
            checkinItems.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-wolf-bg p-3 rounded border border-wolf-border";
                div.innerHTML = `<span class="text-white font-bold text-sm">${item}</span><div class="flex gap-2"><button onclick="editCheckinItem(${idx})" class="text-wolf-muted text-[10px] uppercase font-bold hover:text-white">Edit</button><button onclick="deleteCheckinItem(${idx})" class="text-red-900 text-[10px] uppercase font-bold hover:text-red-500">Del</button></div>`;
                list.appendChild(div);
            });
            openModal('checkin-manager-modal');
        }

        function addCheckinItem() {
            const val = document.getElementById('new-checkin-item').value.trim();
            if(!val) return;
            checkinItems.push(val); localStorage.setItem(STORAGE_KEY_CHECKINS, JSON.stringify(checkinItems));
            document.getElementById('new-checkin-item').value = ''; openCheckinManager();
        }
        function deleteCheckinItem(idx) { checkinItems.splice(idx,1); localStorage.setItem(STORAGE_KEY_CHECKINS, JSON.stringify(checkinItems)); openCheckinManager(); }
        function editCheckinItem(idx) { const v = prompt("Edit Task:", checkinItems[idx]); if(v) { checkinItems[idx] = v; localStorage.setItem(STORAGE_KEY_CHECKINS, JSON.stringify(checkinItems)); openCheckinManager(); } }

        // --- RESTORED ORIGINAL APP LOGIC ---
        function toggleVoiceInput() {
            if(!recognition) return alert("Speech recognition not supported.");
            if (isRecording) { isRecording = false; recognition.stop(); } 
            else { isRecording = true; finalTranscript = ""; try { recognition.start(); } catch(e) { isRecording = false; } }
        }
        function parseVoiceInput(text) {
            const keys = "activity|time|amount|unit|rating|focus|note";
            const extract = (key) => { const regex = new RegExp(`${key}\\s+(.*?)(?=\\s+(?:${keys})|$)`, 'i'); const m = text.match(regex); return m ? m[1].trim() : ""; };
            const data = { activity: extract("activity") || "Voice Log", note: extract("note"), rating: "Neutral", focus: "None", amount: extract("amount"), unit: extract("unit") };
            const now = new Date(); const pad = (n) => n.toString().padStart(2,'0');
            data.time = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
            openActivityModal('voice', data);
        }

        function openActivityModal(mode, data = {}) {
            closeModal('editor-select-modal'); const modal = document.getElementById('activity-modal'); const title = document.getElementById('act-modal-title');
            const now = new Date(); const pad = (n) => n.toString().padStart(2,'0'); const defaultTime = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
            document.getElementById('act-name').value = data.activity || ""; document.getElementById('act-time').value = defaultTime;
            document.getElementById('act-amount').value = data.amount || ""; document.getElementById('act-unit').value = data.unit || "";
            document.getElementById('act-rating').value = data.rating || "Neutral"; document.getElementById('act-focus').value = data.focus || "None";
            document.getElementById('act-note').value = data.note || ""; editingHistoryId = (mode === 'edit') ? data.id : null;
            modal.classList.remove('hidden');
        }

        async function saveActivityLog() {
            const entry = {
                date: new Date(document.getElementById('act-time').value).toISOString(), type: document.getElementById('act-name').value || "Activity",
                duration: `${document.getElementById('act-amount').value} ${document.getElementById('act-unit').value}`.trim() || "---",
                details: { rating: document.getElementById('act-rating').value, focus: document.getElementById('act-focus').value, notes: document.getElementById('act-note').value }
            };
            let h = JSON.parse(localStorage.getItem(STORAGE_KEY_HIST)) || [];
            if (editingHistoryId) { const i = h.findIndex(x => x.date === editingHistoryId); if (i > -1) h[i] = entry; } else { h.push(entry); }
            localStorage.setItem(STORAGE_KEY_HIST, JSON.stringify(h)); closeModal('activity-modal');
            await syncEntryToCloud(entry, editingHistoryId ? 'edit' : 'create', editingHistoryId);
            if(screens.history.classList.contains('active')) showHistory(); else if (screens.completion.classList.contains('active')) goToMenu();
        }

        async function syncEntryToCloud(entry, action, originalDate = null) {
            const url = getApiUrl(); if(!url) return;
            try { await fetch(url, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: action === 'create' ? undefined : 'edit', date: action === 'create' ? entry.date : originalDate, type: entry.type, duration: entry.duration, details: entry.details }) }); } catch(e) {}
        }

        async function saveWeightEntry() {
            const w = document.getElementById('weight-input').value; if(!w) return;
            const entry = { date: new Date().toISOString(), type: "Weight Check-In", duration: "---", details: { weight: w + " lbs" } };
            const h = JSON.parse(localStorage.getItem(STORAGE_KEY_HIST)) || []; h.push(entry); localStorage.setItem(STORAGE_KEY_HIST, JSON.stringify(h));
            await syncEntryToCloud(entry, 'create'); closeModal('weight-modal'); document.getElementById('weight-input').value = ""; alert("Weight Logged.");
        }

        function openManager() { renderManagerList(); openModal('editor-select-modal'); }
        function renderManagerList() {
            els.managerList.innerHTML = '';
            Object.keys(routines).forEach(key => {
                if(key === 'apex_config') {
                    const d = document.createElement('div'); d.className = "flex justify-between items-center bg-wolf-bg p-3 rounded border border-wolf-border";
                    d.innerHTML = `<span class="text-wolf-text font-bold">APEX</span><button onclick="openEditor('apex')" class="text-wolf-accent text-sm font-bold uppercase">Edit</button>`;
                    els.managerList.appendChild(d); return;
                }
                const div = document.createElement('div'); div.className = "flex flex-col bg-wolf-bg p-3 rounded border border-wolf-border gap-2";
                div.innerHTML = `<div class="flex justify-between items-center"><span class="text-wolf-text truncate font-bold">${key}</span></div><div class="flex gap-2 justify-end"><button onclick="renameWorkout('${key}')" class="text-wolf-muted text-xs uppercase">Rename</button><button onclick="openEditor('${key}')" class="text-wolf-muted text-xs uppercase">Edit</button><button onclick="deleteWorkout('${key}')" class="text-red-900 text-xs uppercase">Del</button></div>`;
                els.managerList.appendChild(div);
            });
        }
        async function createNewWorkout() { const n = els.newWorkoutName.value.trim(); if(!n || routines[n]) return; routines[n] = [{type:'work', name:'Exercise', duration:30}]; await saveRoutinesToStorage(); els.newWorkoutName.value=''; renderManagerList(); renderMenuWorkouts(); }
        async function saveRoutinesToStorage() { localStorage.setItem(STORAGE_KEY_ROUTINES, JSON.stringify(routines)); const url = getApiUrl(); if(url) try { await fetch(url, { method:'POST', mode:'no-cors', body: JSON.stringify({action:'save_routine', data:routines}) }); } catch(e){} }

        function selectWorkout(type) { currentWorkoutType = type; activeRoutine = routines[type]; goToQuote(); }
        function confirmApexStart() {
            const m = parseInt(document.getElementById('apex-max-reps').value) || 8; const w = document.getElementById('apex-weight').value || "Bodyweight";
            activeRoutine = generateApexRoutine(routines.apex_config, m); activeRoutine.details = { maxReps: m, weight: w }; currentWorkoutType = 'apex';
            closeModal('apex-config-modal'); goToQuote();
        }
        function startWorkoutSession() { initAudio(); stepIndex = 0; startTime = null; manualRoundCount = 0; switchScreen('workout'); runStep({ type: 'countdown', duration: 10, name: '' }); }
        function runStep(step) {
            clearInterval(timerInt); els.bar.style.width = `${(stepIndex/activeRoutine.length)*100}%`; els.status.textContent = step.type.toUpperCase();
            if (step.type !== 'countdown') { els.currEx.textContent = step.name + (step.round?` (${step.round})`:''); els.nextEx.textContent = activeRoutine[stepIndex+1] ? activeRoutine[stepIndex+1].name : 'FINISH'; }
            if (step.type === 'rep_work' || step.type === 'amrap') {
                els.timed.classList.toggle('hidden', step.type === 'rep_work'); els.rep.classList.remove('hidden');
                if(step.exercises) els.apexList.innerHTML = step.exercises.map(e => `<div class="flex items-center"><span class="w-1.5 h-1.5 bg-wolf-accent mr-3 rounded-full"></span><span class="text-white">${e}</span></div>`).join('');
                if(step.type === 'amrap') { els.amrapContainer.classList.remove('hidden'); els.amrapRounds.textContent = manualRoundCount; }
            } else { els.timed.classList.remove('hidden'); els.rep.classList.add('hidden'); els.amrapContainer.classList.add('hidden'); }
            if (step.type !== 'rep_work' || step.type === 'amrap') {
                let t = step.duration; els.timer.textContent = formatTime(t);
                timerInt = setInterval(() => { t--; els.timer.textContent = formatTime(t); if(t<=3 && t>0) beep('Low'); if(t<=0) { clearInterval(timerInt); beep('High'); if(step.type==='countdown'){ startTime=Date.now(); totalInt=setInterval(()=>els.totalTime.textContent=formatTime(Math.floor((Date.now()-startTime)/1000)),1000); nextStep(); } else nextStep(); } },1000);
            }
        }
        function nextStep() { if(els.status.textContent !== 'GET READY') stepIndex++; if (stepIndex >= activeRoutine.length) { clearInterval(totalInt); switchScreen('completion'); els.finalTime.textContent = els.totalTime.textContent; return; } runStep(activeRoutine[stepIndex]); }
        window.incrementRound = () => { manualRoundCount++; els.amrapRounds.textContent = manualRoundCount; beep('Mid'); };

        function switchTool(tool) { initAudio(); clearInterval(toolInt); document.querySelectorAll('[id^="tool-"]').forEach(el => el.classList.add('hidden')); document.getElementById(`tool-${tool}`).classList.remove('hidden'); }
        function toggleStopwatch() { if(toolInt) { clearInterval(toolInt); toolInt = null; } else { const s = Date.now() - swTime; toolInt = setInterval(() => { swTime = Date.now() - s; document.getElementById('sw-display').textContent = formatTimeTenths(swTime); }, 50); } }
        function formatTime(s) { const m = Math.floor(s/60).toString().padStart(2,'0'); const sc = (s%60).toString().padStart(2,'0'); return `${m}:${sc}`; }
        function formatTimeTenths(ms) { const m = Math.floor(ms/60000).toString().padStart(2,'0'); const s = Math.floor((ms%60000)/1000).toString().padStart(2,'0'); const ds = Math.floor((ms%1000)/100); return `${m}:${s}.${ds}`; }
        function generateApexRoutine(c, m) { const r = []; const reps = []; for(let i=1;i<=m;i++) reps.push(i); for(let i=m-1;i>=1;i--) reps.push(i); reps.forEach((cnt, idx) => { r.push({type:'rep_work', name:`${cnt} Reps`, exercises: c.exercises}); if(idx<reps.length-1) r.push({type:'rest', name:'Rest', duration: c.restTime}); }); return r; }
        function showHistory() {
            switchScreen('history'); const list = document.getElementById('history-list'); list.innerHTML = '';
            let h = JSON.parse(localStorage.getItem(STORAGE_KEY_HIST)) || []; h.sort((a,b)=>new Date(b.date)-new Date(a.date));
            h.forEach(log => {
                const div = document.createElement('div'); div.className = 'bg-wolf-surface border-l-4 border-wolf-border p-4 flex justify-between items-center rounded';
                div.innerHTML = `<div><p class="text-white font-bold uppercase">${log.type}</p><p class="text-wolf-muted text-[10px]">${new Date(log.date).toLocaleString()}</p><p class="text-[10px] text-wolf-accent mt-1">${log.details.notes||''}</p></div><div class="text-xl text-wolf-text font-heading">${log.duration}</div>`;
                list.appendChild(div);
            });
        }
        function switchScreen(name) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[name].classList.add('active'); }
        window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); };
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); };
        window.goToMenu = () => { clearInterval(timerInt); clearInterval(totalInt); switchScreen('menu'); };
        function goToQuote() { const qs = [{q: "Pain is weakness leaving the body.", a: "USMC"}, {q: "I don't stop when I'm tired.", a: "Goggins"}]; const r = qs[Math.floor(Math.random()*qs.length)]; document.getElementById('quote-text').textContent = `"${r.q}"`; document.getElementById('quote-author').textContent = r.a; switchScreen('quote'); }
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function beep(t) { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = t==='High'?800:200; o.start(); o.stop(audioCtx.currentTime+0.1); }
    </script>
</body>
</html>
