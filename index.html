<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOLF ALPHA</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wolf: {
                            bg: '#0c0a09',
                            surface: '#1c1917',
                            border: '#44403c',
                            text: '#e7e5e4',
                            accent: '#b45309',
                            accentHover: '#92400e',
                            muted: '#78716c',
                        }
                    },
                    fontFamily: {
                        heading: ['Oswald', 'sans-serif'],
                        body: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0c0a09;
            color: #e7e5e4;
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        h1, h2, h3, .font-heading { font-family: 'Oswald', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0c0a09; }
        ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 3px; }
    </style>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        const { useState, useEffect, useRef, useCallback } = React;

        // -------------------------------------------------------------------------
        // TYPES & CONSTANTS
        // -------------------------------------------------------------------------

        interface LogEntry {
            id: string; // ISO Date String as ID
            type: 'Workout' | 'Activity';
            title: string; // "Morning Grind" or "Brushing Teeth"
            timestamp: string; // ISO Date String
            duration?: string; // For workouts
            amount: string; // "10", "20", etc.
            unit: string; // "mins", "lbs", etc.
            rating: 'Positive' | 'Negative' | 'Neutral';
            focus: 'High' | 'Medium' | 'Low' | 'None';
            note: string;
            details?: any; // Backward compatibility for specific workout stats
        }

        interface RoutineStep {
            type: 'work' | 'rest' | 'rep_work' | 'cooldown' | 'amrap' | 'countdown';
            name: string;
            duration?: number;
            round?: string;
            exercises?: string[];
        }

        interface Routine {
            [key: string]: RoutineStep[] | any;
        }

        const HARDCODED_URL = "https://script.google.com/macros/s/AKfycbxx2iCp9PgKa2XcY_zZuhvCjN0BeCrthAa93OjHPNDpRr9zXgozhpKi9zZcoEfjGHl6/exec";

        const DEFAULT_ROUTINES: Routine = {
            'Wake Up': [
                { type: 'work', name: 'Bounce & Breathe', duration: 60 },
                { type: 'rep_work', name: 'Shoulder Pinches', exercises: ['10 Reps'] },
                { type: 'cooldown', name: "Child's Pose", duration: 60 }
            ],
            'Morning Grind': [
                { type: 'work', name: 'Push-ups', round: '1/4', duration: 40 },
                { type: 'rest', name: 'Recover', duration: 15 },
                { type: 'work', name: 'Air Squats', round: '1/4', duration: 40 },
                { type: 'cooldown', name: 'Stretch', duration: 60 }
            ],
            'Garage Games': [
                 { type: "amrap", name: "AMRAP 20", duration: 1200, exercises: ["10 Med Ball Cleans", "10 Pull-Ups"] }
            ]
        };

        // -------------------------------------------------------------------------
        // UTILS
        // -------------------------------------------------------------------------

        const formatTime = (s: number): string => {
            const min = Math.floor(s / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            return `${min}:${sec}`;
        };

        const formatTimeTenths = (ms: number): string => {
            const m = Math.floor(ms / 60000).toString().padStart(2, '0');
            const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            const ds = Math.floor((ms % 1000) / 100);
            return `${m}:${s}.${ds}`;
        };

        const parseRelativeTime = (timeStr: string): Date => {
            const now = new Date();
            const str = timeStr.toLowerCase().trim();

            // Handle "10:30 AM" or "5:00 PM"
            const timeMatch = str.match(/(\d{1,2}):(\d{2})\s*(am|pm)?/);
            if (timeMatch) {
                let hours = parseInt(timeMatch[1]);
                const minutes = parseInt(timeMatch[2]);
                const period = timeMatch[3];

                if (period === 'pm' && hours < 12) hours += 12;
                if (period === 'am' && hours === 12) hours = 0;

                const d = new Date();
                d.setHours(hours, minutes, 0, 0);
                return d;
            }

            // Handle "2 hours ago", "10 minutes ago"
            const relativeMatch = str.match(/(\d+)\s*(hour|minute|sec|second)s?\s*ago/);
            if (relativeMatch) {
                const val = parseInt(relativeMatch[1]);
                const unit = relativeMatch[2];
                if (unit.startsWith('hour')) now.setHours(now.getHours() - val);
                else if (unit.startsWith('minute')) now.setMinutes(now.getMinutes() - val);
                else if (unit.startsWith('sec')) now.setSeconds(now.getSeconds() - val);
                return now;
            }

            return now;
        };

        const parseVoiceInput = (transcript: string): Partial<LogEntry> => {
            const lower = transcript.toLowerCase();
            
            const result: Partial<LogEntry> = {
                title: 'New Activity',
                timestamp: new Date().toISOString(),
                amount: '',
                unit: '',
                rating: 'Neutral',
                focus: 'None',
                note: ''
            };

            const extract = (key: string, nextKeys: string[]): string | null => {
                const startIdx = lower.indexOf(key);
                if (startIdx === -1) return null;
                
                let contentStart = startIdx + key.length;
                
                let minNextIdx = lower.length;
                nextKeys.forEach(nk => {
                    const idx = lower.indexOf(nk, contentStart);
                    if (idx !== -1 && idx < minNextIdx) {
                        minNextIdx = idx;
                    }
                });

                return lower.substring(contentStart, minNextIdx).trim();
            };

            const keys = ['activity', 'time', 'amount', 'unit', 'rating', 'focus', 'note'];

            const act = extract('activity', keys);
            if (act) result.title = act.charAt(0).toUpperCase() + act.slice(1);

            const timeStr = extract('time', keys);
            if (timeStr) result.timestamp = parseRelativeTime(timeStr).toISOString();

            const amt = extract('amount', keys);
            if (amt) result.amount = amt;

            const unit = extract('unit', keys);
            if (unit) result.unit = unit;

            const rate = extract('rating', keys);
            if (rate) {
                if (rate.includes('positive') || rate.includes('good')) result.rating = 'Positive';
                else if (rate.includes('negative') || rate.includes('bad')) result.rating = 'Negative';
                else result.rating = 'Neutral';
            }

            const focus = extract('focus', keys);
            if (focus) {
                if (focus.includes('high')) result.focus = 'High';
                else if (focus.includes('medium')) result.focus = 'Medium';
                else if (focus.includes('low')) result.focus = 'Low';
                else result.focus = 'None';
            }

            const note = extract('note', keys);
            if (note) result.note = note.charAt(0).toUpperCase() + note.slice(1);

            return result;
        };

        // -------------------------------------------------------------------------
        // COMPONENTS
        // -------------------------------------------------------------------------

        const Button = ({ onClick, children, variant = 'primary', className = '', disabled = false }: any) => {
            const base = "font-heading uppercase letter-spacing-0.1em transition-all rounded-lg shadow-md active:transform active:translate-y-px disabled:opacity-50 disabled:cursor-not-allowed ";
            const styles = variant === 'primary' 
                ? "bg-wolf-accent text-white hover:bg-wolf-accentHover" 
                : "bg-wolf-surface border border-wolf-border text-wolf-text hover:text-white hover:border-wolf-muted";
            return <button disabled={disabled} onClick={onClick} className={`${base} ${styles} ${className}`}>{children}</button>;
        };

        const Modal = ({ isOpen, onClose, children, title }: any) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-wolf-surface border border-wolf-border p-6 w-full max-w-md rounded-xl shadow-2xl flex flex-col max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="font-heading text-2xl text-wolf-accent tracking-wide">{title}</h2>
                            <button onClick={onClose} className="text-wolf-muted hover:text-white">âœ•</button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        // --- Activity/Log Modal ---

        interface ActivityModalProps {
            isOpen: boolean;
            onClose: () => void;
            initialData?: Partial<LogEntry>;
            onSave: (entry: LogEntry) => void;
        }

        const ActivityModal: React.FC<ActivityModalProps> = ({ isOpen, onClose, initialData, onSave }) => {
            const [data, setData] = useState<Partial<LogEntry>>({});

            useEffect(() => {
                if (isOpen) {
                    setData({
                        title: '',
                        amount: '',
                        unit: '',
                        rating: 'Neutral',
                        focus: 'None',
                        note: '',
                        timestamp: new Date().toISOString(),
                        ...initialData
                    });
                }
            }, [isOpen, initialData]);

            const handleSave = () => {
                const entry: LogEntry = {
                    id: data.timestamp || new Date().toISOString(),
                    type: data.type || 'Activity',
                    title: data.title || 'Untitled',
                    timestamp: data.timestamp || new Date().toISOString(),
                    amount: data.amount || '',
                    unit: data.unit || '',
                    rating: data.rating || 'Neutral',
                    focus: data.focus || 'None',
                    note: data.note || '',
                    duration: data.duration,
                    details: data.details
                };
                onSave(entry);
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="LOG ENTRY">
                    <div className="space-y-4">
                        <div>
                            <label className="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Activity / Name</label>
                            <input 
                                type="text" 
                                value={data.title || ''} 
                                onChange={e => setData({...data, title: e.target.value})}
                                className="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none"
                            />
                        </div>
                        
                        <div className="flex gap-2">
                            <div className="flex-1">
                                <label className="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Time</label>
                                <input 
                                    type="datetime-local" 
                                    value={data.timestamp ? new Date(data.timestamp).toISOString().slice(0, 16) : ''}
                                    onChange={e => setData({...data, timestamp: new Date(e.target.value).toISOString()})}
                                    className="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none text-xs"
                                />
                            </div>
                        </div>

                        <div className="flex gap-2">
                            <div className="flex-1">
                                <label className="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Amount</label>
                                <input 
                                    type="text" 
                                    placeholder="e.g. 10, 30:00"
                                    value={data.amount || ''} 
                                    onChange={e => setData({...data, amount: e.target.value})}
                                    className="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none"
                                />
                            </div>
                            <div className="flex-1">
                                <label className="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Unit</label>
                                <input 
                                    type="text" 
                                    placeholder="mins, lbs, reps"
                                    value={data.unit || ''} 
                                    onChange={e => setData({...data, unit: e.target.value})}
                                    className="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none"
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Rating</label>
                            <div className="flex gap-2">
                                {['Positive', 'Neutral', 'Negative'].map((r) => (
                                    <button 
                                        key={r}
                                        onClick={() => setData({...data, rating: r as any})}
                                        className={`flex-1 py-2 rounded text-xs uppercase font-bold border ${data.rating === r ? 'bg-wolf-accent border-wolf-accent text-white' : 'bg-transparent border-wolf-border text-wolf-muted hover:border-white'}`}
                                    >
                                        {r}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label className="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Focus Level</label>
                            <div className="flex gap-2">
                                {['High', 'Medium', 'Low', 'None'].map((f) => (
                                    <button 
                                        key={f}
                                        onClick={() => setData({...data, focus: f as any})}
                                        className={`flex-1 py-2 rounded text-[10px] uppercase font-bold border ${data.focus === f ? 'bg-wolf-surface border-white text-white' : 'bg-transparent border-wolf-border text-wolf-muted hover:border-wolf-muted'}`}
                                    >
                                        {f}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label className="block text-[10px] uppercase text-wolf-muted font-bold mb-1">Notes</label>
                            <textarea 
                                rows={3} 
                                value={data.note || ''}
                                onChange={e => setData({...data, note: e.target.value})}
                                className="w-full bg-wolf-bg border border-wolf-border text-white p-3 rounded focus:border-wolf-accent outline-none"
                            />
                        </div>
                    </div>
                    <Button onClick={handleSave} className="w-full py-4 text-xl mt-6">SAVE ENTRY</Button>
                </Modal>
            );
        };

        // -------------------------------------------------------------------------
        // MAIN APP
        // -------------------------------------------------------------------------

        function App() {
            const [screen, setScreen] = useState('menu');
            const [routines, setRoutines] = useState(DEFAULT_ROUTINES);
            const [logs, setLogs] = useState([]);
            const [syncStatus, setSyncStatus] = useState('Checking...');
            
            // Activity Modal State
            const [showActivityModal, setShowActivityModal] = useState(false);
            const [activityModalData, setActivityModalData] = useState({});

            // Voice State
            const [isListening, setIsListening] = useState(false);

            // Audio Ref
            const audioCtxRef = useRef(null);

            // Load Data
            useEffect(() => {
                const storedLogs = localStorage.getItem('wolf_logs');
                if (storedLogs) setLogs(JSON.parse(storedLogs));
                
                const storedRoutines = localStorage.getItem('wolf_routines');
                if (storedRoutines) setRoutines(JSON.parse(storedRoutines));

                // Sync
                if (HARDCODED_URL && HARDCODED_URL.startsWith('http')) {
                    setSyncStatus('Syncing...');
                    fetch(HARDCODED_URL)
                        .then(res => res.json())
                        .then(data => {
                            if (data.history) {
                                setLogs(data.history.reverse());
                                localStorage.setItem('wolf_logs', JSON.stringify(data.history));
                            }
                            if (data.routines) {
                                setRoutines(data.routines);
                                localStorage.setItem('wolf_routines', JSON.stringify(data.routines));
                            }
                            setSyncStatus('Cloud Connected');
                        })
                        .catch(() => setSyncStatus('Local Mode'));
                } else {
                    setSyncStatus('Local Mode');
                }
            }, []);

            const saveLog = async (entry) => {
                const newLogs = [entry, ...logs];
                setLogs(newLogs);
                localStorage.setItem('wolf_logs', JSON.stringify(newLogs));
                
                // Push to cloud
                if (HARDCODED_URL && HARDCODED_URL.startsWith('http')) {
                    try {
                        await fetch(HARDCODED_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(entry)
                        });
                    } catch (e) { console.error("Sync failed", e); }
                }
            };

            const deleteLog = async (id) => {
                if(!confirm("Delete this log?")) return;
                const newLogs = logs.filter(l => l.id !== id);
                setLogs(newLogs);
                localStorage.setItem('wolf_logs', JSON.stringify(newLogs));
                if (HARDCODED_URL && HARDCODED_URL.startsWith('http')) {
                    try {
                        await fetch(HARDCODED_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'delete', date: id })
                        });
                    } catch (e) { console.error("Sync failed", e); }
                }
            };

            const initAudio = () => {
                if (!audioCtxRef.current) {
                    audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtxRef.current.state === 'suspended') {
                    audioCtxRef.current.resume();
                }
            };

            const beep = (type) => {
                if (!audioCtxRef.current) return;
                const osc = audioCtxRef.current.createOscillator();
                const gain = audioCtxRef.current.createGain();
                const freqs = { 'Low': 150, 'Mid': 400, 'High': 800 };
                osc.connect(gain);
                gain.connect(audioCtxRef.current.destination);
                osc.frequency.value = freqs[type];
                osc.type = 'triangle';
                gain.gain.setValueAtTime(0.1, audioCtxRef.current.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtxRef.current.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtxRef.current.currentTime + 0.3);
            };

            // Voice Handler
            const startVoiceInput = () => {
                if (!('webkitSpeechRecognition' in window)) {
                    alert("Voice input not supported in this browser.");
                    return;
                }
                const recognition = new window.webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onerror = () => setIsListening(false);

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const parsed = parseVoiceInput(transcript);
                    setActivityModalData({ ...parsed, type: 'Activity' });
                    setShowActivityModal(true);
                };

                recognition.start();
            };

            // --- Sub-Screens ---

            const MenuScreen = () => (
                <div className="flex flex-col items-center justify-center min-h-screen p-6 relative">
                    <h1 className="font-heading text-6xl text-wolf-text tracking-tight mb-2">WOLF<span className="text-wolf-accent">ALPHA</span></h1>
                    <p className="text-wolf-muted text-sm uppercase tracking-[0.3em] mb-12">Conquer Your Day</p>

                    <div className="w-full max-w-sm space-y-4">
                        <Button onClick={() => setScreen('protocols')} className="w-full py-4 text-xl shadow-lg shadow-orange-900/20">
                            SAVED PROTOCOLS
                        </Button>
                    </div>

                    <div className="w-full max-w-sm grid grid-cols-2 gap-3 mt-8 pt-8 border-t border-wolf-border">
                        <Button variant="secondary" onClick={() => setScreen('tools')} className="py-3 text-[10px] tracking-widest">Tools</Button>
                        <Button variant="secondary" onClick={() => setScreen('history')} className="py-3 text-[10px] tracking-widest">History</Button>
                        <Button 
                            variant="secondary" 
                            onClick={() => {
                                setActivityModalData({ type: 'Activity' });
                                setShowActivityModal(true);
                            }} 
                            className="py-3 text-[10px] tracking-widest col-span-2 flex justify-center items-center gap-2 border-wolf-accent text-wolf-accent"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Log Activity
                        </Button>
                        <Button 
                            variant="secondary" 
                            onClick={startVoiceInput} 
                            className={`py-3 text-[10px] tracking-widest col-span-2 flex justify-center items-center gap-2 ${isListening ? 'bg-red-900 animate-pulse text-white' : ''}`}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            {isListening ? "Listening..." : "Voice Input"}
                        </Button>
                    </div>
                    
                    <div className="mt-8 text-[10px] text-wolf-muted uppercase tracking-widest opacity-50">{syncStatus}</div>
                </div>
            );

            const ProtocolsScreen = () => (
                <div className="flex flex-col h-screen p-6 bg-wolf-bg">
                    <div className="flex justify-between items-center mb-6 pb-4 border-b border-wolf-border">
                        <h2 className="font-heading text-3xl text-wolf-text">PROTOCOLS</h2>
                        <button onClick={() => setScreen('menu')} className="text-wolf-muted uppercase text-xs font-bold hover:text-white">Back</button>
                    </div>
                    <div className="flex-grow overflow-y-auto space-y-3 pb-20">
                        {Object.keys(routines).map(key => (
                            <Button key={key} onClick={() => startWorkout(key)} className="w-full py-4 text-lg">
                                {key}
                            </Button>
                        ))}
                    </div>
                </div>
            );

            const HistoryScreen = () => (
                <div className="flex flex-col h-screen p-6">
                    <div className="flex justify-between items-center mb-6 pb-4 border-b border-wolf-border">
                        <h2 className="font-heading text-3xl text-wolf-text">HISTORY</h2>
                        <button onClick={() => setScreen('menu')} className="btn-secondary px-4 py-2 text-sm text-wolf-muted uppercase font-bold tracking-widest hover:text-white">Back</button>
                    </div>
                    <div className="flex-grow overflow-y-auto space-y-3 pb-20">
                        {logs.length === 0 && <div className="text-center text-wolf-muted mt-10">No logs found.</div>}
                        {logs.map((log) => (
                            <div key={log.id} className="bg-wolf-surface border-l-4 border-wolf-accent p-4 flex justify-between items-center rounded-r shadow-sm">
                                <div className="flex-grow">
                                    <div className="flex items-center gap-2">
                                        <p className="text-white font-bold text-lg uppercase font-heading tracking-wide">{log.title}</p>
                                        {log.type === 'Activity' && <span className="bg-wolf-border text-[8px] px-1 rounded uppercase">Activity</span>}
                                    </div>
                                    <p className="text-wolf-muted text-xs uppercase">{new Date(log.timestamp).toLocaleString()}</p>
                                    
                                    <div className="flex flex-wrap gap-2 mt-2">
                                        {log.rating !== 'Neutral' && (
                                            <span className={`text-[10px] px-2 py-0.5 rounded border ${log.rating === 'Positive' ? 'text-green-500 border-green-900 bg-green-900/10' : 'text-red-500 border-red-900 bg-red-900/10'}`}>{log.rating}</span>
                                        )}
                                        {log.focus !== 'None' && (
                                            <span className="text-[10px] px-2 py-0.5 rounded border border-wolf-border text-wolf-muted">Focus: {log.focus}</span>
                                        )}
                                        {log.note && <span className="text-[10px] text-wolf-muted italic w-full block mt-1">"{log.note}"</span>}
                                    </div>
                                </div>
                                <div className="flex flex-col items-end gap-2">
                                    <div className="font-heading text-2xl text-wolf-text">
                                        {log.amount || log.duration || '--'} 
                                        <span className="text-sm text-wolf-muted ml-1">{log.unit}</span>
                                    </div>
                                    <button onClick={() => deleteLog(log.id)} className="text-[10px] text-red-900 uppercase hover:text-red-500 border border-wolf-border px-2 rounded">Del</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // --- Workout Logic ---
            const [activeRoutine, setActiveRoutine] = useState([]);
            const [currentStepIndex, setCurrentStepIndex] = useState(0);
            const [timeLeft, setTimeLeft] = useState(0);
            const [isPaused, setIsPaused] = useState(false);
            const [startTime, setStartTime] = useState(0);
            const [elapsedTime, setElapsedTime] = useState(0);
            const timerRef = useRef(null);

            const startWorkout = (key) => {
                initAudio();
                const routine = routines[key];
                const steps = Array.isArray(routine) ? routine : [];
                if(key.includes("Garage") || key.includes("AMRAP")) {
                    setActiveRoutine([{ type: 'amrap', name: key, duration: 1200, exercises: routine[0]?.exercises }]);
                } else {
                    setActiveRoutine([{ type: 'countdown', name: 'Get Ready', duration: 10 }, ...steps]);
                }
                
                setCurrentStepIndex(0);
                setScreen('workout');
                setStartTime(Date.now());
                setIsPaused(false);
            };

            useEffect(() => {
                if (screen !== 'workout') return;
                const step = activeRoutine[currentStepIndex];
                if (!step) {
                    finishWorkout();
                    return;
                }
                if (step.type !== 'rep_work' && step.type !== 'amrap' && step.duration) {
                    setTimeLeft(step.duration);
                } else {
                    setTimeLeft(0);
                }
            }, [currentStepIndex, screen]);

            useEffect(() => {
                if (screen !== 'workout' || isPaused) {
                    if (timerRef.current) clearInterval(timerRef.current);
                    return;
                }

                const step = activeRoutine[currentStepIndex];
                if (step && (step.type === 'rep_work')) return; 

                timerRef.current = setInterval(() => {
                    setElapsedTime(Math.floor((Date.now() - startTime) / 1000));
                    if (timeLeft > 0) {
                        setTimeLeft(prev => {
                            if (prev <= 1) {
                                beep('High');
                                nextStep();
                                return 0;
                            }
                            if (prev <= 4) beep('Low');
                            return prev - 1;
                        });
                    }
                }, 1000);
                return () => { if (timerRef.current) clearInterval(timerRef.current); };
            }, [timeLeft, screen, isPaused, currentStepIndex]);

            const nextStep = () => {
                setCurrentStepIndex(prev => prev + 1);
                beep('Mid');
            };

            const finishWorkout = () => {
                setScreen('menu');
                const totalDuration = formatTime(Math.floor((Date.now() - startTime) / 1000));
                setActivityModalData({
                    type: 'Workout',
                    title: 'Completed Workout',
                    amount: totalDuration,
                    unit: 'time',
                    rating: 'Neutral',
                    focus: 'None',
                    note: '',
                    timestamp: new Date().toISOString()
                });
                setShowActivityModal(true);
            };

            const WorkoutScreen = () => {
                const step = activeRoutine[currentStepIndex];
                if(!step) return null;

                return (
                    <div className="flex flex-col h-screen bg-wolf-bg relative">
                        <div className="absolute top-0 left-0 w-full p-6 flex justify-between z-20">
                            <div>
                                <span className="text-wolf-muted text-[10px] uppercase tracking-widest block">Elapsed</span>
                                <span className="font-heading text-2xl text-wolf-text">{formatTime(elapsedTime)}</span>
                            </div>
                            <button onClick={() => setScreen('menu')} className="text-wolf-muted hover:text-white text-xs uppercase font-bold border border-wolf-muted px-2 rounded">Exit</button>
                        </div>
                        
                        <div className="flex-grow flex flex-col items-center justify-center p-4 z-10 text-center">
                            <p className="font-heading text-3xl text-wolf-accent uppercase tracking-widest mb-2 animate-pulse">{step.type === 'countdown' ? 'GET READY' : step.type}</p>
                            <p className="text-4xl md:text-7xl font-bold text-white mb-8 leading-none">{step.name} {step.round ? `(${step.round})` : ''}</p>
                            {step.type !== 'rep_work' ? (
                                <div className="font-heading text-[8rem] text-wolf-text leading-none tabular-nums">{timeLeft > 59 ? formatTime(timeLeft) : timeLeft}</div>
                            ) : (
                                <div className="space-y-2 mb-8">
                                    {step.exercises?.map((ex, i) => (
                                        <div key={i} className="text-2xl text-white">{ex}</div>
                                    ))}
                                </div>
                            )}
                            {(step.type === 'rep_work' || step.type === 'amrap' || isPaused) && (
                                <Button onClick={nextStep} className="px-10 py-4 text-xl mt-8">NEXT / COMPLETE</Button>
                            )}
                        </div>
                        
                        <div className="p-6 text-center">
                            <span className="text-wolf-muted text-[10px] uppercase tracking-widest block mb-1">Up Next</span>
                            <span className="text-wolf-text text-xl font-heading uppercase">{activeRoutine[currentStepIndex+1]?.name || 'COMPLETE'}</span>
                        </div>
                    </div>
                );
            };

            // --- Tools (Full Implementation) ---
            const ToolsScreen = () => {
                const [activeTool, setActiveTool] = useState('stopwatch');
                const [countdown, setCountdown] = useState(false); // 10s countdown checkbox

                // Stopwatch State
                const [swTime, setSwTime] = useState(0);
                const [swRunning, setSwRunning] = useState(false);
                const [swLaps, setSwLaps] = useState([]);
                const [swPrep, setSwPrep] = useState(0); // Countdown state

                // Timer State
                const [tmDuration, setTmDuration] = useState({ h: 0, m: 0, s: 0 });
                const [tmTimeLeft, setTmTimeLeft] = useState(0);
                const [tmRunning, setTmRunning] = useState(false);
                const [tmPrep, setTmPrep] = useState(0);
                const [tmRounds, setTmRounds] = useState(0);
                const [tmTrackRounds, setTmTrackRounds] = useState(false);
                const [tmOrig, setTmOrig] = useState(0);

                // Tabata State
                const [tbConfig, setTbConfig] = useState({ work: 20, rest: 10, rounds: 8 });
                const [tbState, setTbState] = useState('idle');
                const [tbTimeLeft, setTbTimeLeft] = useState(0);
                const [tbCurrentRound, setTbCurrentRound] = useState(1);

                const toolInterval = useRef(null);

                // Cleanup interval on unmount or switch
                useEffect(() => {
                    return () => { if(toolInterval.current) clearInterval(toolInterval.current); };
                }, []);

                // --- Stopwatch Logic ---
                useEffect(() => {
                    if (activeTool !== 'stopwatch') return;
                    if (swRunning || swPrep > 0) {
                        const start = Date.now() - swTime;
                        toolInterval.current = setInterval(() => {
                            if (swPrep > 0) {
                                setSwPrep(p => {
                                    if (p <= 1) { beep('High'); setSwRunning(true); return 0; }
                                    if (p <= 4) beep('Low');
                                    return p - 1;
                                });
                            } else if (swRunning) {
                                setSwTime(Date.now() - start); // Drift-less timing
                            }
                        }, swPrep > 0 ? 1000 : 50);
                    } else {
                        if(toolInterval.current) clearInterval(toolInterval.current);
                    }
                    return () => { if(toolInterval.current) clearInterval(toolInterval.current); };
                }, [swRunning, swPrep, activeTool]);

                const toggleStopwatch = () => {
                    initAudio();
                    if (swRunning) { setSwRunning(false); }
                    else if (swTime === 0 && countdown) { setSwPrep(10); }
                    else { setSwRunning(true); }
                };
                const lapStopwatch = () => {
                    if(!swRunning) return;
                    setSwLaps([swTime, ...swLaps]);
                };
                const resetStopwatch = () => { setSwRunning(false); setSwTime(0); setSwLaps([]); setSwPrep(0); };

                // --- Timer Logic ---
                useEffect(() => {
                    if (activeTool !== 'timer') return;
                    if (tmRunning || tmPrep > 0) {
                        toolInterval.current = setInterval(() => {
                            if (tmPrep > 0) {
                                setTmPrep(p => {
                                    if (p <= 1) { beep('High'); setTmRunning(true); return 0; }
                                    if (p <= 4) beep('Low');
                                    return p - 1;
                                });
                            } else if (tmRunning) {
                                setTmTimeLeft(prev => {
                                    if (prev <= 1) {
                                        beep('High');
                                        setTmRunning(false);
                                        setActivityModalData({
                                            type: 'Activity',
                                            title: 'Custom Timer',
                                            amount: formatTime(tmOrig),
                                            unit: 'time',
                                            details: tmTrackRounds ? { roundsCompleted: tmRounds } : undefined
                                        });
                                        setShowActivityModal(true);
                                        return 0;
                                    }
                                    if (prev <= 4) beep('Low');
                                    return prev - 1;
                                });
                            }
                        }, 1000);
                    } else {
                        if(toolInterval.current) clearInterval(toolInterval.current);
                    }
                    return () => { if(toolInterval.current) clearInterval(toolInterval.current); };
                }, [tmRunning, tmPrep, activeTool, tmRounds, tmOrig]);

                const toggleTimer = () => {
                    initAudio();
                    if (tmRunning) { setTmRunning(false); }
                    else {
                        if (tmTimeLeft === 0) {
                            // Init
                            const totalSec = (tmDuration.h * 3600) + (tmDuration.m * 60) + tmDuration.s;
                            if(totalSec === 0) return;
                            setTmTimeLeft(totalSec);
                            setTmOrig(totalSec);
                            if(countdown) setTmPrep(10);
                            else setTmRunning(true);
                            if(tmTrackRounds) setTmRounds(0);
                        } else {
                            // Resume
                            setTmRunning(true);
                        }
                    }
                };
                const resetTimer = () => { setTmRunning(false); setTmTimeLeft(0); setTmPrep(0); setTmRounds(0); };

                // --- Tabata Logic ---
                useEffect(() => {
                    if (activeTool !== 'tabata') return;
                    if (tbState !== 'idle') {
                        toolInterval.current = setInterval(() => {
                            setTbTimeLeft(prev => {
                                // Transition Logic
                                if (prev <= 0) {
                                    if (tbState === 'prep') {
                                        beep('High');
                                        setTbState('work');
                                        return tbConfig.work;
                                    }
                                    if (tbState === 'work') {
                                        beep('Mid');
                                        if (tbCurrentRound >= tbConfig.rounds) {
                                            // Finish
                                            setTbState('idle');
                                            alert("TABATA COMPLETE");
                                            return 0;
                                        }
                                        setTbState('rest');
                                        return tbConfig.rest;
                                    }
                                    if (tbState === 'rest') {
                                        beep('High');
                                        setTbCurrentRound(r => r + 1);
                                        setTbState('work');
                                        return tbConfig.work;
                                    }
                                }
                                // Beeps
                                if (prev <= 4 && prev > 1) beep('Low');
                                return prev - 1;
                            });
                        }, 1000);
                    } else {
                        if(toolInterval.current) clearInterval(toolInterval.current);
                    }
                    return () => { if(toolInterval.current) clearInterval(toolInterval.current); };
                }, [tbState, tbConfig, tbCurrentRound, activeTool]);

                const toggleTabata = () => {
                    initAudio();
                    if (tbState !== 'idle') {
                        setTbState('idle');
                    } else {
                        setTbCurrentRound(1);
                        if (countdown) {
                            setTbState('prep');
                            setTbTimeLeft(10);
                        } else {
                            setTbState('work');
                            setTbTimeLeft(tbConfig.work);
                        }
                    }
                };

                return (
                    <div className="flex flex-col h-screen p-6 bg-wolf-bg">
                        <div className="flex justify-between items-center mb-6 pb-4 border-b border-wolf-border">
                            <h2 className="font-heading text-3xl text-wolf-text">TOOLS</h2>
                            <button onClick={() => setScreen('menu')} className="text-wolf-muted uppercase text-xs font-bold hover:text-white">Exit</button>
                        </div>
                        
                        <div className="flex gap-2 mb-6">
                            {['stopwatch', 'timer', 'tabata'].map(t => (
                                <button key={t} onClick={() => { setActiveTool(t); if(toolInterval.current) clearInterval(toolInterval.current); }} className={`flex-1 py-2 rounded text-xs uppercase font-bold transition-colors ${activeTool===t ? 'bg-wolf-accent text-white' : 'bg-wolf-surface text-wolf-muted'}`}>
                                    {t}
                                </button>
                            ))}
                        </div>
                        
                        <div className="flex-grow flex flex-col items-center justify-start text-center pt-4">
                            
                            {/* STOPWATCH UI */}
                            {activeTool === 'stopwatch' && (
                                <>
                                    {swPrep > 0 && <div className="text-wolf-accent uppercase tracking-widest text-2xl mb-2 font-heading animate-pulse">GET READY</div>}
                                    <div className="font-heading text-7xl md:text-9xl text-white mb-4 tabular-nums">
                                        {swPrep > 0 ? `00:${swPrep.toString().padStart(2,'0')}.0` : formatTimeTenths(swTime)}
                                    </div>
                                    <div className="flex gap-4 w-full max-w-md mb-6">
                                        <Button onClick={toggleStopwatch} className={`flex-1 py-4 text-xl ${swRunning || swPrep > 0 ? 'bg-red-900 hover:bg-red-800' : ''}`}>
                                            {swRunning || swPrep > 0 ? 'STOP' : 'START'}
                                        </Button>
                                        <Button variant="secondary" onClick={swRunning ? lapStopwatch : resetStopwatch} className="flex-1 py-4 text-xl">
                                            {swRunning ? 'LAP' : 'RESET'}
                                        </Button>
                                    </div>
                                    <div className="flex items-center gap-2 mb-8">
                                        <input type="checkbox" checked={countdown} onChange={e => setCountdown(e.target.checked)} className="w-5 h-5 accent-wolf-accent cursor-pointer" />
                                        <label className="text-xs uppercase text-wolf-muted font-bold cursor-pointer">10 Sec Countdown</label>
                                    </div>
                                    <div className="w-full max-w-md h-40 overflow-y-auto bg-wolf-surface border border-wolf-border rounded-lg p-2 text-sm space-y-1">
                                        {swLaps.map((lap, i) => (
                                            <div key={i} className="flex justify-between border-b border-wolf-border pb-1">
                                                <span className="text-wolf-muted">Lap {swLaps.length - i}</span>
                                                <span className="text-white font-bold">{formatTimeTenths(lap - (swLaps[i+1] || 0))} / {formatTimeTenths(lap)}</span>
                                            </div>
                                        ))}
                                        {swLaps.length === 0 && <div className="text-wolf-muted text-center italic py-2">Laps will appear here</div>}
                                    </div>
                                </>
                            )}

                            {/* TIMER UI */}
                            {activeTool === 'timer' && (
                                <>
                                    {tmTimeLeft === 0 && !tmRunning && tmPrep === 0 ? (
                                        <div className="flex flex-col items-center animate-in fade-in">
                                            <div className="flex gap-4 items-center mb-8">
                                                {['h','m','s'].map((k) => (
                                                    <div key={k} className="flex flex-col">
                                                        <label className="text-[10px] uppercase text-wolf-muted mb-1 tracking-widest">{k === 'h' ? 'Hours' : k === 'm' ? 'Mins' : 'Secs'}</label>
                                                        <input 
                                                            type="number" 
                                                            value={tmDuration[k] || ''} 
                                                            onChange={e => setTmDuration({...tmDuration, [k]: parseInt(e.target.value)||0})}
                                                            className="bg-transparent border-2 border-wolf-border color-white text-center font-heading rounded-lg w-20 text-4xl p-2 focus:border-wolf-accent outline-none text-white" 
                                                            placeholder="00"
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="flex items-center gap-3 mb-10 bg-wolf-surface px-4 py-2 rounded-lg border border-wolf-border">
                                                <input type="checkbox" checked={tmTrackRounds} onChange={e => setTmTrackRounds(e.target.checked)} className="w-5 h-5 accent-wolf-accent cursor-pointer" />
                                                <label className="text-sm uppercase font-bold text-wolf-muted cursor-pointer select-none">Track Rounds</label>
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            {tmPrep > 0 && <div className="text-wolf-accent uppercase tracking-widest text-2xl mb-2 font-heading animate-pulse">GET READY</div>}
                                            <div className="font-heading text-7xl md:text-9xl text-white mb-4 tabular-nums">
                                                {tmPrep > 0 ? `00:${tmPrep.toString().padStart(2,'0')}` : formatTime(tmTimeLeft)}
                                            </div>
                                            {tmTrackRounds && (
                                                <div className="mb-6 flex flex-col items-center">
                                                    <p className="text-wolf-muted uppercase text-[10px] tracking-widest mb-2">Round Counter</p>
                                                    <div className="flex items-center gap-6">
                                                        <div className="font-heading text-5xl text-white">{tmRounds}</div>
                                                        <Button variant="secondary" onClick={() => setTmRounds(r => r + 1)} className="px-4 py-2 text-lg border-wolf-accent text-wolf-accent">+ ROUND</Button>
                                                    </div>
                                                </div>
                                            )}
                                        </>
                                    )}
                                    
                                    <div className="flex gap-4 w-full max-w-md mb-6">
                                        <Button onClick={toggleTimer} className={`flex-1 py-4 text-xl ${tmRunning || tmPrep > 0 ? 'bg-red-900 hover:bg-red-800' : ''}`}>
                                            {tmRunning || tmPrep > 0 ? 'PAUSE' : tmTimeLeft > 0 ? 'RESUME' : 'START'}
                                        </Button>
                                        <Button variant="secondary" onClick={resetTimer} className="flex-1 py-4 text-xl">RESET</Button>
                                    </div>

                                    {tmTimeLeft === 0 && !tmRunning && (
                                        <div className="flex items-center gap-2">
                                            <input type="checkbox" checked={countdown} onChange={e => setCountdown(e.target.checked)} className="w-5 h-5 accent-wolf-accent cursor-pointer" />
                                            <label className="text-xs uppercase text-wolf-muted font-bold cursor-pointer">10 Sec Countdown</label>
                                        </div>
                                    )}
                                </>
                            )}

                            {/* TABATA UI */}
                            {activeTool === 'tabata' && (
                                <>
                                    {tbState === 'idle' ? (
                                        <div className="w-full max-w-sm space-y-4 mb-8">
                                            <div className="flex justify-between items-center">
                                                <label className="text-wolf-muted uppercase text-sm font-bold">Work (Sec)</label>
                                                <input type="number" value={tbConfig.work} onChange={e => setTbConfig({...tbConfig, work: parseInt(e.target.value)})} className="bg-transparent border-2 border-wolf-border text-white text-center font-heading rounded w-24 text-2xl p-1" />
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <label className="text-wolf-muted uppercase text-sm font-bold">Rest (Sec)</label>
                                                <input type="number" value={tbConfig.rest} onChange={e => setTbConfig({...tbConfig, rest: parseInt(e.target.value)})} className="bg-transparent border-2 border-wolf-border text-white text-center font-heading rounded w-24 text-2xl p-1" />
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <label className="text-wolf-muted uppercase text-sm font-bold">Rounds</label>
                                                <input type="number" value={tbConfig.rounds} onChange={e => setTbConfig({...tbConfig, rounds: parseInt(e.target.value)})} className="bg-transparent border-2 border-wolf-border text-white text-center font-heading rounded w-24 text-2xl p-1" />
                                            </div>
                                            <div className="flex items-center justify-center gap-2 mt-4 pt-4">
                                                <input type="checkbox" checked={countdown} onChange={e => setCountdown(e.target.checked)} className="w-5 h-5 accent-wolf-accent cursor-pointer" />
                                                <label className="text-xs uppercase text-wolf-muted font-bold cursor-pointer">10 Sec Countdown</label>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="animate-in zoom-in duration-300">
                                            <p className={`${tbState === 'work' ? 'text-wolf-accent' : tbState === 'rest' ? 'text-green-500' : 'text-white'} uppercase tracking-widest text-2xl mb-2 font-heading animate-pulse`}>
                                                {tbState === 'prep' ? 'GET READY' : tbState.toUpperCase()}
                                            </p>
                                            <div className="font-heading text-8xl md:text-9xl text-white mb-2 tabular-nums">
                                                {tbState === 'prep' ? tbTimeLeft : tbTimeLeft}
                                            </div>
                                            <p className="text-wolf-muted uppercase tracking-widest text-2xl font-bold">Round {tbCurrentRound}/{tbConfig.rounds}</p>
                                        </div>
                                    )}
                                    
                                    <Button onClick={toggleTabata} className={`w-full max-w-sm py-4 text-xl mt-6 ${tbState !== 'idle' ? 'bg-red-900 hover:bg-red-800' : ''}`}>
                                        {tbState !== 'idle' ? 'STOP TABATA' : 'START TABATA'}
                                    </Button>
                                </>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-screen w-full bg-wolf-bg text-wolf-text overflow-hidden selection:bg-wolf-accent selection:text-white">
                    {screen === 'menu' && <MenuScreen />}
                    {screen === 'history' && <HistoryScreen />}
                    {screen === 'protocols' && <ProtocolsScreen />}
                    {screen === 'workout' && <WorkoutScreen />}
                    {screen === 'tools' && <ToolsScreen />}
                    
                    <ActivityModal 
                        isOpen={showActivityModal} 
                        onClose={() => setShowActivityModal(false)} 
                        initialData={activityModalData}
                        onSave={saveLog}
                    />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
